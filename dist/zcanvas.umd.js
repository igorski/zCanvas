!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).zcanvas={})}(this,(function(t){"use strict";class e{constructor(){this._eventMap=[],this._disposed=!1}add(t,e,s){return!this.has(t,e)&&(t.addEventListener(e,s,!1),this._eventMap.push({target:t,type:e,listener:s}),!0)}has(t,e){let s=this._eventMap.length;for(;s--;){const i=this._eventMap[s];if(i.target===t&&i.type==e)return!0}return!1}remove(t,e){let s=this._eventMap.length;for(;s--;){const i=this._eventMap[s];if(i.target===t&&i.type===e)return t.removeEventListener(e,i.listener,!1),this._eventMap.splice(s,1),!0}return!1}dispose(){if(this._disposed)return;let t=this._eventMap.length;for(;t--;){const e=this._eventMap[t];this.remove(e.target,e.type)}this._eventMap=null,this._disposed=!0}}let s;function i(t=0,e=0,s=!1){const i=document.createElement("canvas"),h=i.getContext("2d",s?{willReadFrequently:!0}:void 0);return 0!==t&&0!==e&&(i.width=t,i.height=e),{cvs:i,ctx:h}}function h(){return s||(s=i().cvs),s}function n(t,e,s,i){r(t,e,s,i)}async function o(t){t instanceof Blob&&(t=await async function(t){const e=await a(t),{cvs:s,ctx:h}=i(e.width,e.height);return h.drawImage(e,0,0),s}(t)),r(h(),t);const e=await createImageBitmap(h());return s.width=1,s.height=1,e}function a(t){const e=URL.createObjectURL(t),s=()=>{URL.revokeObjectURL(e)};return new Promise(((t,i)=>{const h=new Image;h.onload=()=>{s(),t(h)},h.onerror=t=>{s(),i(t)},h.src=e}))}function r(t,e,s,i){const h=t.getContext("2d");s=s??e.width,i=i??e.height,t.width=s,t.height=i,h.clearRect(0,0,s,i),h.drawImage(e,0,0,s,i)}async function l(t){const e=new FileReader;return new Promise(((s,i)=>{e.onload=e=>{var h;if(!(null==(h=null==e?void 0:e.target)?void 0:h.result))return i();s(new Blob([e.target.result],{type:t.type}))},e.onerror=t=>i(t),e.readAsArrayBuffer(t)}))}const d={loadImage:t=>new Promise((async(s,i)=>{let h;if(t instanceof File?h=await l(t):t instanceof Blob&&(h=t),void 0!==h){try{const t=await a(h);d.onReady(t).then((()=>s(c(t))))}catch(g){i(g)}return}const n=function(t){const e=t.substring(0,5);return"data:"===e||"blob:"===e}(t),o=new window.Image,r=new e,p=()=>{r.dispose(),d.onReady(o).then((()=>s(c(o)))).catch(i)};var u;n||(u=o,function(t){const{location:e}=window;return!(!t.startsWith("./")&&!t.startsWith(`${e.protocol}//${e.host}`)&&/^http[s]?:/.test(t))}(t)||(u.crossOrigin="Anonymous"),r.add(o,"load",p),r.add(o,"error",(()=>{r.dispose(),i()}))),o.src=t,n&&p()})),async loadBitmap(t){const{image:e}=await d.loadImage(t);return o(e)},isReady:t=>!0===t.complete&&"number"==typeof t.naturalWidth&&t.naturalWidth>0,onReady:t=>new Promise(((e,s)=>{let i=0;!function h(){d.isReady(t)?e():60==++i?s(new Error("Image could not be resolved.")):requestAnimationFrame(h)}()}))};function c(t){const e={image:t,size:{width:0,height:0}};return t instanceof window.HTMLImageElement&&(e.size={width:(s=t).width||s.naturalWidth,height:s.height||s.naturalHeight}),e;var s}function p(t,e){e.font=`${t.size}${t.unit} "${t.font}"`,e.fillStyle=t.color}class u{constructor(t,e){this._index=0,this._map=new Map,this._createFn=t,this._destroyFn=e}dispose(){const t=[...this._map].map((([t])=>t));for(;t.length>0;)this.remove(t.shift());this._map=void 0}get(t){return this._map.get(t)}set(t,e){if(this.has(t)){if(this.get(t)===e)return;this.remove(t)}this._map.set(t,e)}has(t){return this._map.has(t)}remove(t){var e;if(!this.has(t))return!1;const s=this.get(t);return null==(e=this._destroyFn)||e.call(this,s),this._map.delete(t)}next(){let t;const e=this._index.toString();return this.has(e)?t=this.get(e):this._createFn&&(t=this._createFn(),this.set(e,t)),++this._index,t}fill(t){const e=this._index;for(let s=0;s<t;++s)this.next();this._index=e}reset(){this._index=0}}const{min:g,max:m}=Math,_=.5;let b,f,w,G;const x=Math.PI/180;function v(t){return t>0?t+.5<<0:0|t}function Z(t,e,s){const{left:i,top:h,width:n,height:o}=t;return s.width=n*e,s.height=o*e,s.left=i-(s.width-n)*_,s.top=h-(s.height-o)*_,s}const X="transparent",C=2*Math.PI,R=.5;let y=1,L="setTransform";class W{constructor(t,e=!1){this._debug=e,this._cvs=t,this._ctx=t.getContext("2d"),this._bmp=new u(void 0,(t=>{t.close()})),this._ptn=new u}dispose(){this._bmp.dispose(),this._ptn.dispose(),this._cvs=void 0}cacheResource(t,e){this._bmp.set(t,e)}getResource(t){return this._bmp.get(t)}disposeResource(t){this._bmp.remove(t)}setDimensions(t,e){this._cvs.width=t,this._cvs.height=e}setSmoothing(t){const e=this._ctx;["imageSmoothingEnabled","mozImageSmoothingEnabled","oImageSmoothingEnabled","webkitImageSmoothingEnabled"].forEach((s=>{void 0!==e[s]&&(e[s]=t)}))}setPixelRatio(t){y=t,L=1===y?"setTransform":"transform"}save(){this._ctx.save()}restore(){this._ctx.restore()}translate(t,e){this._ctx.translate(t,e)}scale(t,e=t){this._ctx.scale(t,e)}rotate(t){this._ctx.rotate(t)}transform(t,e,s,i,h,n){this._ctx.transform(t,e,s,i,h,n)}setBlendMode(t){this._ctx.globalCompositeOperation=t}setAlpha(t){this._ctx.globalAlpha=t}createPattern(t,e){this._bmp.has(t)&&this._ptn.set(t,this._ctx.createPattern(this._bmp.get(t),e))}drawPath(t,e=X,s){let i;this._ctx.beginPath(),this._ctx.moveTo(t[0].x,t[0].y);for(let h=1,n=t.length;h<n;++h)i=t[h],this._ctx.lineTo(i.x,i.y);e!==X&&this._ctx.fill(),s&&(H(this._ctx,s),this._ctx.stroke())}clearRect(t,e,s,i,h){const n=h?this.prepare(h,t,e,s,i):0;this._ctx.clearRect(t,e,s,i),this.applyReset(n)}drawRect(t,e,s,i,h=X,n,o){const a=o?this.prepare(o,t,e,s,i):0;h!==X&&(this._ctx.fillStyle=h,this._ctx.fillRect(t,e,s,i)),n&&(H(this._ctx,n),this._ctx.strokeRect(R+t,R+e,s,i)),this.applyReset(a)}drawRoundRect(t,e,s,i,h,n=X,o,a){const r=a?this.prepare(a,t,e,s,i):0;this._ctx.beginPath(),n!==X&&(this._ctx.fillStyle=n,this._ctx.roundRect(t,e,s,i,h),this._ctx.fill()),o&&(H(this._ctx,o),this._ctx.roundRect(R+t,R+e,s,i,h),this._ctx.stroke()),this.applyReset(r)}drawCircle(t,e,s,i=X,h,n){const o=n?this.prepare(n,t,e,2*s,2*s):0;this._ctx.beginPath(),this._ctx.arc(t+s,e+s,s,0,C,!1),i!==X&&(this._ctx.fillStyle=i,this._ctx.fill()),h&&(H(this._ctx,h),this._ctx.stroke()),this.applyReset(o)}drawEllipse(t,e,s,i,h=X,n,o){const a=o?this.prepare(o,t,e,2*s,2*i):0;this._ctx.beginPath(),this._ctx.ellipse(t,e,s,i,0,0,C,!1),h!==X&&(this._ctx.fillStyle=h,this._ctx.fill()),n&&(H(this._ctx,n),this._ctx.stroke()),this.applyReset(a)}drawImage(t,e,s,i,h,n){if(!this._bmp.has(t))return;const o=n?this.prepare(n,e,s,i,h):0;void 0===i?this._ctx.drawImage(this._bmp.get(t),e,s):this._ctx.drawImage(this._bmp.get(t),e,s,i,h),this._debug&&this.drawRect(e,s,i,h,X,{size:1,color:"red"}),this.applyReset(o)}drawImageCropped(t,e,s,i,h,n,o,a,r,l){if(!this._bmp.has(t))return;if(null==l?void 0:l.safeMode){if(a<=0||r<=0)return;const n=this._bmp.get(t),o=(a=Math.min(this._ctx.canvas.width,a))/i,l=(r=Math.min(this._ctx.canvas.height,r))/h;e+i>n.width&&(a-=o*(e+i-n.width),i-=e+i-n.width),s+h>n.height&&(r-=l*(s+h-n.height),h-=s+h-n.height)}const d=l?this.prepare(l,n,o,a,r):0;this._ctx.drawImage(this._bmp.get(t),R+e<<0,R+s<<0,R+i<<0,R+h<<0,R+n<<0,R+o<<0,R+a<<0,R+r<<0),this._debug&&this.drawRect(n,o,a,r,X,{size:1,color:"red"}),this.applyReset(d)}drawText(t,e,s,i){const{lines:h,width:n,height:o}=function(t,e){p(t,e);const s=t.text.split("\n"),i=[];let h,n=0,o=0,a=e.measureText("Wq");h=t.lineHeight?t.lineHeight:a.actualBoundingBoxAscent+a.actualBoundingBoxDescent;const r=a.actualBoundingBoxAscent;let l=0;return s.forEach(((s,d)=>{if(l=Math.round(r+d*h),t.spacing){const e=s.split("");n=Math.max(n,e.length*t.spacing)}else a=e.measureText(s),n=Math.max(n,a.actualBoundingBoxRight);i.push({line:s,top:l}),o+=h})),{lines:i,width:Math.ceil(n),height:Math.ceil(o)}}(t,this._ctx);t.center&&(e-=n*R,s-=o*R);const a=i?this.prepare(i,e,s,n,o):0;!function(t,e,s,i,h){p(s,t);const n=s.spacing??1;e.forEach((({line:e,top:o})=>{s.spacing?e.split("").forEach(((e,s)=>{t.fillText(e,i+Math.round(s*n),h+o)})):t.fillText(e,i,h+o)}))}(this._ctx,h,t,e,s),this.applyReset(a)}drawPattern(t,e,s,i,h){if(!this._ptn.has(t))return;const n=this._ptn.get(t);this._ctx.fillStyle=n,this._ctx.fillRect(e,s,i,h)}prepare(t,e,s,i,h){var n,o;const a=1!==t.scale,r=0!==t.rotation,l=1!==t.alpha,d=void 0!==t.blendMode,c=l||d,p=a||r;if(c)this.save();else if(!p)return 0;if(p){const a=t.scale??1,r=(null==(n=t.pivot)?void 0:n.x)??e+i*R,l=(null==(o=t.pivot)?void 0:o.y)??s+h*R,d=t.rotation*x,c=Math.cos(d)*a,p=Math.sin(d)*a;this._ctx[L](c,p,-p,c,r-r*c+l*p,l-r*p-l*c)}return d&&this.setBlendMode(t.blendMode),l&&this.setAlpha(t.alpha),c?1:2}applyReset(t){2===t?this._ctx.setTransform(y,0,0,y,0,0):1===t&&this.restore()}}function H(t,e){t.lineWidth=e.size,t.strokeStyle=e.color,e.cap&&(t.lineCap=e.cap),e.dash&&t.setLineDash(e.dash)}const S="IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIHQodCxlKXtlLmZvbnQ9YCR7dC5zaXplfSR7dC51bml0fSAiJHt0LmZvbnR9ImAsZS5maWxsU3R5bGU9dC5jb2xvcn1jbGFzcyBle2NvbnN0cnVjdG9yKHQsZSl7dGhpcy5faW5kZXg9MCx0aGlzLl9tYXA9bmV3IE1hcCx0aGlzLl9jcmVhdGVGbj10LHRoaXMuX2Rlc3Ryb3lGbj1lfWRpc3Bvc2UoKXtjb25zdCB0PVsuLi50aGlzLl9tYXBdLm1hcCgoKFt0XSk9PnQpKTtmb3IoO3QubGVuZ3RoPjA7KXRoaXMucmVtb3ZlKHQuc2hpZnQoKSk7dGhpcy5fbWFwPXZvaWQgMH1nZXQodCl7cmV0dXJuIHRoaXMuX21hcC5nZXQodCl9c2V0KHQsZSl7aWYodGhpcy5oYXModCkpe2lmKHRoaXMuZ2V0KHQpPT09ZSlyZXR1cm47dGhpcy5yZW1vdmUodCl9dGhpcy5fbWFwLnNldCh0LGUpfWhhcyh0KXtyZXR1cm4gdGhpcy5fbWFwLmhhcyh0KX1yZW1vdmUodCl7dmFyIGU7aWYoIXRoaXMuaGFzKHQpKXJldHVybiExO2NvbnN0IHM9dGhpcy5nZXQodCk7cmV0dXJuIG51bGw9PShlPXRoaXMuX2Rlc3Ryb3lGbil8fGUuY2FsbCh0aGlzLHMpLHRoaXMuX21hcC5kZWxldGUodCl9bmV4dCgpe2xldCB0O2NvbnN0IGU9dGhpcy5faW5kZXgudG9TdHJpbmcoKTtyZXR1cm4gdGhpcy5oYXMoZSk/dD10aGlzLmdldChlKTp0aGlzLl9jcmVhdGVGbiYmKHQ9dGhpcy5fY3JlYXRlRm4oKSx0aGlzLnNldChlLHQpKSwrK3RoaXMuX2luZGV4LHR9ZmlsbCh0KXtjb25zdCBlPXRoaXMuX2luZGV4O2ZvcihsZXQgcz0wO3M8dDsrK3MpdGhpcy5uZXh0KCk7dGhpcy5faW5kZXg9ZX1yZXNldCgpe3RoaXMuX2luZGV4PTB9fWNvbnN0IHM9TWF0aC5QSS8xODAsaT0idHJhbnNwYXJlbnQiLGE9MipNYXRoLlBJLGg9LjU7bGV0IG4sbyxyPTEsYz0ic2V0VHJhbnNmb3JtIjtjbGFzcyBse2NvbnN0cnVjdG9yKHQscz0hMSl7dGhpcy5fZGVidWc9cyx0aGlzLl9jdnM9dCx0aGlzLl9jdHg9dC5nZXRDb250ZXh0KCIyZCIpLHRoaXMuX2JtcD1uZXcgZSh2b2lkIDAsKHQ9Pnt0LmNsb3NlKCl9KSksdGhpcy5fcHRuPW5ldyBlfWRpc3Bvc2UoKXt0aGlzLl9ibXAuZGlzcG9zZSgpLHRoaXMuX3B0bi5kaXNwb3NlKCksdGhpcy5fY3ZzPXZvaWQgMH1jYWNoZVJlc291cmNlKHQsZSl7dGhpcy5fYm1wLnNldCh0LGUpfWdldFJlc291cmNlKHQpe3JldHVybiB0aGlzLl9ibXAuZ2V0KHQpfWRpc3Bvc2VSZXNvdXJjZSh0KXt0aGlzLl9ibXAucmVtb3ZlKHQpfXNldERpbWVuc2lvbnModCxlKXt0aGlzLl9jdnMud2lkdGg9dCx0aGlzLl9jdnMuaGVpZ2h0PWV9c2V0U21vb3RoaW5nKHQpe2NvbnN0IGU9dGhpcy5fY3R4O1siaW1hZ2VTbW9vdGhpbmdFbmFibGVkIiwibW96SW1hZ2VTbW9vdGhpbmdFbmFibGVkIiwib0ltYWdlU21vb3RoaW5nRW5hYmxlZCIsIndlYmtpdEltYWdlU21vb3RoaW5nRW5hYmxlZCJdLmZvckVhY2goKHM9Pnt2b2lkIDAhPT1lW3NdJiYoZVtzXT10KX0pKX1zZXRQaXhlbFJhdGlvKHQpe3I9dCxjPTE9PT1yPyJzZXRUcmFuc2Zvcm0iOiJ0cmFuc2Zvcm0ifXNhdmUoKXt0aGlzLl9jdHguc2F2ZSgpfXJlc3RvcmUoKXt0aGlzLl9jdHgucmVzdG9yZSgpfXRyYW5zbGF0ZSh0LGUpe3RoaXMuX2N0eC50cmFuc2xhdGUodCxlKX1zY2FsZSh0LGU9dCl7dGhpcy5fY3R4LnNjYWxlKHQsZSl9cm90YXRlKHQpe3RoaXMuX2N0eC5yb3RhdGUodCl9dHJhbnNmb3JtKHQsZSxzLGksYSxoKXt0aGlzLl9jdHgudHJhbnNmb3JtKHQsZSxzLGksYSxoKX1zZXRCbGVuZE1vZGUodCl7dGhpcy5fY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbj10fXNldEFscGhhKHQpe3RoaXMuX2N0eC5nbG9iYWxBbHBoYT10fWNyZWF0ZVBhdHRlcm4odCxlKXt0aGlzLl9ibXAuaGFzKHQpJiZ0aGlzLl9wdG4uc2V0KHQsdGhpcy5fY3R4LmNyZWF0ZVBhdHRlcm4odGhpcy5fYm1wLmdldCh0KSxlKSl9ZHJhd1BhdGgodCxlPWkscyl7bGV0IGE7dGhpcy5fY3R4LmJlZ2luUGF0aCgpLHRoaXMuX2N0eC5tb3ZlVG8odFswXS54LHRbMF0ueSk7Zm9yKGxldCBpPTEsaD10Lmxlbmd0aDtpPGg7KytpKWE9dFtpXSx0aGlzLl9jdHgubGluZVRvKGEueCxhLnkpO2UhPT1pJiZ0aGlzLl9jdHguZmlsbCgpLHMmJihkKHRoaXMuX2N0eCxzKSx0aGlzLl9jdHguc3Ryb2tlKCkpfWNsZWFyUmVjdCh0LGUscyxpLGEpe2NvbnN0IGg9YT90aGlzLnByZXBhcmUoYSx0LGUscyxpKTowO3RoaXMuX2N0eC5jbGVhclJlY3QodCxlLHMsaSksdGhpcy5hcHBseVJlc2V0KGgpfWRyYXdSZWN0KHQsZSxzLGEsbj1pLG8scil7Y29uc3QgYz1yP3RoaXMucHJlcGFyZShyLHQsZSxzLGEpOjA7biE9PWkmJih0aGlzLl9jdHguZmlsbFN0eWxlPW4sdGhpcy5fY3R4LmZpbGxSZWN0KHQsZSxzLGEpKSxvJiYoZCh0aGlzLl9jdHgsbyksdGhpcy5fY3R4LnN0cm9rZVJlY3QoaCt0LGgrZSxzLGEpKSx0aGlzLmFwcGx5UmVzZXQoYyl9ZHJhd1JvdW5kUmVjdCh0LGUscyxhLG4sbz1pLHIsYyl7Y29uc3QgbD1jP3RoaXMucHJlcGFyZShjLHQsZSxzLGEpOjA7dGhpcy5fY3R4LmJlZ2luUGF0aCgpLG8hPT1pJiYodGhpcy5fY3R4LmZpbGxTdHlsZT1vLHRoaXMuX2N0eC5yb3VuZFJlY3QodCxlLHMsYSxuKSx0aGlzLl9jdHguZmlsbCgpKSxyJiYoZCh0aGlzLl9jdHgsciksdGhpcy5fY3R4LnJvdW5kUmVjdChoK3QsaCtlLHMsYSxuKSx0aGlzLl9jdHguc3Ryb2tlKCkpLHRoaXMuYXBwbHlSZXNldChsKX1kcmF3Q2lyY2xlKHQsZSxzLGg9aSxuLG8pe2NvbnN0IHI9bz90aGlzLnByZXBhcmUobyx0LGUsMipzLDIqcyk6MDt0aGlzLl9jdHguYmVnaW5QYXRoKCksdGhpcy5fY3R4LmFyYyh0K3MsZStzLHMsMCxhLCExKSxoIT09aSYmKHRoaXMuX2N0eC5maWxsU3R5bGU9aCx0aGlzLl9jdHguZmlsbCgpKSxuJiYoZCh0aGlzLl9jdHgsbiksdGhpcy5fY3R4LnN0cm9rZSgpKSx0aGlzLmFwcGx5UmVzZXQocil9ZHJhd0VsbGlwc2UodCxlLHMsaCxuPWksbyxyKXtjb25zdCBjPXI/dGhpcy5wcmVwYXJlKHIsdCxlLDIqcywyKmgpOjA7dGhpcy5fY3R4LmJlZ2luUGF0aCgpLHRoaXMuX2N0eC5lbGxpcHNlKHQsZSxzLGgsMCwwLGEsITEpLG4hPT1pJiYodGhpcy5fY3R4LmZpbGxTdHlsZT1uLHRoaXMuX2N0eC5maWxsKCkpLG8mJihkKHRoaXMuX2N0eCxvKSx0aGlzLl9jdHguc3Ryb2tlKCkpLHRoaXMuYXBwbHlSZXNldChjKX1kcmF3SW1hZ2UodCxlLHMsYSxoLG4pe2lmKCF0aGlzLl9ibXAuaGFzKHQpKXJldHVybjtjb25zdCBvPW4/dGhpcy5wcmVwYXJlKG4sZSxzLGEsaCk6MDt2b2lkIDA9PT1hP3RoaXMuX2N0eC5kcmF3SW1hZ2UodGhpcy5fYm1wLmdldCh0KSxlLHMpOnRoaXMuX2N0eC5kcmF3SW1hZ2UodGhpcy5fYm1wLmdldCh0KSxlLHMsYSxoKSx0aGlzLl9kZWJ1ZyYmdGhpcy5kcmF3UmVjdChlLHMsYSxoLGkse3NpemU6MSxjb2xvcjoicmVkIn0pLHRoaXMuYXBwbHlSZXNldChvKX1kcmF3SW1hZ2VDcm9wcGVkKHQsZSxzLGEsbixvLHIsYyxsLGQpe2lmKCF0aGlzLl9ibXAuaGFzKHQpKXJldHVybjtpZihudWxsPT1kP3ZvaWQgMDpkLnNhZmVNb2RlKXtpZihjPD0wfHxsPD0wKXJldHVybjtjb25zdCBpPXRoaXMuX2JtcC5nZXQodCksaD0oYz1NYXRoLm1pbih0aGlzLl9jdHguY2FudmFzLndpZHRoLGMpKS9hLG89KGw9TWF0aC5taW4odGhpcy5fY3R4LmNhbnZhcy5oZWlnaHQsbCkpL247ZSthPmkud2lkdGgmJihjLT1oKihlK2EtaS53aWR0aCksYS09ZSthLWkud2lkdGgpLHMrbj5pLmhlaWdodCYmKGwtPW8qKHMrbi1pLmhlaWdodCksbi09cytuLWkuaGVpZ2h0KX1jb25zdCBwPWQ/dGhpcy5wcmVwYXJlKGQsbyxyLGMsbCk6MDt0aGlzLl9jdHguZHJhd0ltYWdlKHRoaXMuX2JtcC5nZXQodCksaCtlPDwwLGgrczw8MCxoK2E8PDAsaCtuPDwwLGgrbzw8MCxoK3I8PDAsaCtjPDwwLGgrbDw8MCksdGhpcy5fZGVidWcmJnRoaXMuZHJhd1JlY3QobyxyLGMsbCxpLHtzaXplOjEsY29sb3I6InJlZCJ9KSx0aGlzLmFwcGx5UmVzZXQocCl9ZHJhd1RleHQoZSxzLGksYSl7Y29uc3R7bGluZXM6bix3aWR0aDpvLGhlaWdodDpyfT1mdW5jdGlvbihlLHMpe3QoZSxzKTtjb25zdCBpPWUudGV4dC5zcGxpdCgiXG4iKSxhPVtdO2xldCBoLG49MCxvPTAscj1zLm1lYXN1cmVUZXh0KCJXcSIpO2g9ZS5saW5lSGVpZ2h0P2UubGluZUhlaWdodDpyLmFjdHVhbEJvdW5kaW5nQm94QXNjZW50K3IuYWN0dWFsQm91bmRpbmdCb3hEZXNjZW50O2NvbnN0IGM9ci5hY3R1YWxCb3VuZGluZ0JveEFzY2VudDtsZXQgbD0wO3JldHVybiBpLmZvckVhY2goKCh0LGkpPT57aWYobD1NYXRoLnJvdW5kKGMraSpoKSxlLnNwYWNpbmcpe2NvbnN0IHM9dC5zcGxpdCgiIik7bj1NYXRoLm1heChuLHMubGVuZ3RoKmUuc3BhY2luZyl9ZWxzZSByPXMubWVhc3VyZVRleHQodCksbj1NYXRoLm1heChuLHIuYWN0dWFsQm91bmRpbmdCb3hSaWdodCk7YS5wdXNoKHtsaW5lOnQsdG9wOmx9KSxvKz1ofSkpLHtsaW5lczphLHdpZHRoOk1hdGguY2VpbChuKSxoZWlnaHQ6TWF0aC5jZWlsKG8pfX0oZSx0aGlzLl9jdHgpO2UuY2VudGVyJiYocy09bypoLGktPXIqaCk7Y29uc3QgYz1hP3RoaXMucHJlcGFyZShhLHMsaSxvLHIpOjA7IWZ1bmN0aW9uKGUscyxpLGEsaCl7dChpLGUpO2NvbnN0IG49aS5zcGFjaW5nPz8xO3MuZm9yRWFjaCgoKHtsaW5lOnQsdG9wOnN9KT0+e2kuc3BhY2luZz90LnNwbGl0KCIiKS5mb3JFYWNoKCgodCxpKT0+e2UuZmlsbFRleHQodCxhK01hdGgucm91bmQoaSpuKSxoK3MpfSkpOmUuZmlsbFRleHQodCxhLGgrcyl9KSl9KHRoaXMuX2N0eCxuLGUscyxpKSx0aGlzLmFwcGx5UmVzZXQoYyl9ZHJhd1BhdHRlcm4odCxlLHMsaSxhKXtpZighdGhpcy5fcHRuLmhhcyh0KSlyZXR1cm47Y29uc3QgaD10aGlzLl9wdG4uZ2V0KHQpO3RoaXMuX2N0eC5maWxsU3R5bGU9aCx0aGlzLl9jdHguZmlsbFJlY3QoZSxzLGksYSl9cHJlcGFyZSh0LGUsaSxhLG4pe3ZhciBvLHI7Y29uc3QgbD0xIT09dC5zY2FsZSxkPTAhPT10LnJvdGF0aW9uLHA9MSE9PXQuYWxwaGEsXz12b2lkIDAhPT10LmJsZW5kTW9kZSxnPXB8fF8sbT1sfHxkO2lmKGcpdGhpcy5zYXZlKCk7ZWxzZSBpZighbSlyZXR1cm4gMDtpZihtKXtjb25zdCBsPXQuc2NhbGU/PzEsZD0obnVsbD09KG89dC5waXZvdCk/dm9pZCAwOm8ueCk/P2UrYSpoLHA9KG51bGw9PShyPXQucGl2b3QpP3ZvaWQgMDpyLnkpPz9pK24qaCxfPXQucm90YXRpb24qcyxnPU1hdGguY29zKF8pKmwsbT1NYXRoLnNpbihfKSpsO3RoaXMuX2N0eFtjXShnLG0sLW0sZyxkLWQqZytwKm0scC1kKm0tcCpnKX1yZXR1cm4gXyYmdGhpcy5zZXRCbGVuZE1vZGUodC5ibGVuZE1vZGUpLHAmJnRoaXMuc2V0QWxwaGEodC5hbHBoYSksZz8xOjJ9YXBwbHlSZXNldCh0KXsyPT09dD90aGlzLl9jdHguc2V0VHJhbnNmb3JtKHIsMCwwLHIsMCwwKToxPT09dCYmdGhpcy5yZXN0b3JlKCl9fWZ1bmN0aW9uIGQodCxlKXt0LmxpbmVXaWR0aD1lLnNpemUsdC5zdHJva2VTdHlsZT1lLmNvbG9yLGUuY2FwJiYodC5saW5lQ2FwPWUuY2FwKSxlLmRhc2gmJnQuc2V0TGluZURhc2goZS5kYXNoKX1vbm1lc3NhZ2U9dD0+e3N3aXRjaCh0LmRhdGEuY21kKXtkZWZhdWx0OmJyZWFrO2Nhc2UiaW5pdCI6bz10LmRhdGEuY2FudmFzLG49bmV3IGwobyx0LmRhdGEuZGVidWcpO2JyZWFrO2Nhc2UibG9hZFJlc291cmNlIjohYXN5bmMgZnVuY3Rpb24odCxlKXt0cnl7bGV0IHM7aWYoZSBpbnN0YW5jZW9mIEZpbGUpe2NvbnN0IHQ9YXdhaXQgYXN5bmMgZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRmlsZVJlYWRlcjtyZXR1cm4gbmV3IFByb21pc2UoKChzLGkpPT57ZS5vbmxvYWQ9ZT0+e3ZhciBhO2lmKCEobnVsbD09KGE9bnVsbD09ZT92b2lkIDA6ZS50YXJnZXQpP3ZvaWQgMDphLnJlc3VsdCkpcmV0dXJuIGkoKTtzKG5ldyBCbG9iKFtlLnRhcmdldC5yZXN1bHRdLHt0eXBlOnQudHlwZX0pKX0sZS5vbmVycm9yPXQ9PmkodCksZS5yZWFkQXNBcnJheUJ1ZmZlcih0KX0pKX0oZSk7cz1hd2FpdCBjcmVhdGVJbWFnZUJpdG1hcCh0KX1lbHNlIGlmKGUgaW5zdGFuY2VvZiBCbG9iKXM9YXdhaXQgY3JlYXRlSW1hZ2VCaXRtYXAoZSk7ZWxzZSBpZigic3RyaW5nIj09dHlwZW9mIGUpe2NvbnN0IHQ9YXdhaXQgZmV0Y2goZSksaT1hd2FpdCB0LmJsb2IoKTtzPWF3YWl0IGNyZWF0ZUltYWdlQml0bWFwKGkpfWVsc2UgZSBpbnN0YW5jZW9mIEltYWdlQml0bWFwJiYocz1lKTtudWxsPT1ufHxuLmNhY2hlUmVzb3VyY2UodCxzKSxwb3N0TWVzc2FnZSh7Y21kOiJvbmxvYWQiLGlkOnQsc2l6ZTp7d2lkdGg6cy53aWR0aCxoZWlnaHQ6cy5oZWlnaHR9fSl9Y2F0Y2gocyl7cG9zdE1lc3NhZ2Uoe2NtZDoib25lcnJvciIsaWQ6dCxlcnJvcjoobnVsbD09cz92b2lkIDA6cy5tZXNzYWdlKT8/c30pfX0odC5kYXRhLmlkLHQuZGF0YS5zb3VyY2UpO2JyZWFrO2Nhc2UiZ2V0UmVzb3VyY2UiOmNvbnN0IGU9bnVsbD09bj92b2lkIDA6bi5nZXRSZXNvdXJjZSh0LmRhdGEuaWQpO3Bvc3RNZXNzYWdlKHtjbWQ6Im9ucmVzb3VyY2UiLGlkOnQuZGF0YS5pZCxiaXRtYXA6ZX0pO2JyZWFrO2Nhc2UiZGlzcG9zZVJlc291cmNlIjpudWxsPT1ufHxuLmRpc3Bvc2VSZXNvdXJjZSguLi50LmRhdGEuYXJncyk7YnJlYWs7Y2FzZSJkaXNwb3NlIjpudWxsPT1ufHxuLmRpc3Bvc2UoKSxvPXZvaWQgMCxuPXZvaWQgMDticmVhaztjYXNlInJlbmRlciI6aWYoIW58fCF0LmRhdGEuY29tbWFuZHMpcmV0dXJuO2Zvcihjb25zdCBzIG9mIHQuZGF0YS5jb21tYW5kcyl7Y29uc3QgdD1zLnNoaWZ0KCk7blt0XSguLi5zKX1wb3N0TWVzc2FnZSh7Y21kOiJvbnJlbmRlciJ9KTticmVhaztjYXNlInNldERpbWVuc2lvbnMiOmNhc2Uic2V0UGl4ZWxSYXRpbyI6Y2FzZSJzZXRTbW9vdGhpbmciOmNhc2UiY3JlYXRlUGF0dGVybiI6blt0LmRhdGEuY21kXSguLi50LmRhdGEuYXJncyl9fX0oKTsK",Y="undefined"!=typeof window&&window.Blob&&new Blob([atob(S)],{type:"text/javascript;charset=utf-8"});function z(){let t;try{if(t=Y&&(window.URL||window.webkitURL).createObjectURL(Y),!t)throw"";return new Worker(t)}catch(e){return new Worker("data:application/javascript;base64,"+S)}finally{t&&(window.URL||window.webkitURL).revokeObjectURL(t)}}class K{constructor(t,e=!1,s=!1){if(this._useW=!1,this._el=t,e&&"function"==typeof this._el.transferControlToOffscreen){this._useW=!0,this._cbs=new Map,this._pl=new u((()=>[]),(t=>{t.length=0})),this._pl.fill(1e3),this._cmds=[];const e=t.transferControlToOffscreen();this._wkr=new z,this._wkr.postMessage({cmd:"init",canvas:e,debug:s},[e]),this._wkr.onmessage=this.handleMessage.bind(this)}else this._rdr=new W(this._el,s)}loadResource(t,e){return new Promise((async(s,i)=>{if(e instanceof ImageBitmap)this._useW?this.wrappedWorkerLoad(t,e,s,i,!0):(this._rdr.cacheResource(t,e),s({width:e.width,height:e.height}));else if("string"!=typeof e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){const i=await o(e);return this.loadResource(t,i).then((t=>s(t)))}if(e instanceof File)if(this._useW)this.wrappedWorkerLoad(t,e,s,i);else{const h=await l(e);this.wrappedLoad(t,h,s,i)}else e instanceof Blob?this._useW?this.wrappedWorkerLoad(t,e,s,i):this.wrappedLoad(t,e,s,i):i("Unsupported resource type: "+typeof e)}else if(e=e.startsWith("./")?new URL(e,document.baseURI).href:e,this._useW)this.wrappedWorkerLoad(t,e,s,i);else{const h=await d.loadImage(e);this.wrappedLoad(t,h.image,s,i)}}))}getResource(t){return new Promise(((e,s)=>{this._useW?(this._cbs.set(t,{resolve:e,reject:s}),this._wkr.postMessage({cmd:"getResource",id:t})):e(this._rdr.getResource(t))}))}disposeResource(t){this.getBackend("disposeResource",t)}onCommandsReady(){this._useW&&(this._wkr.postMessage({cmd:"render",commands:this._cmds}),this._cmds.length=0,this._pl.reset())}dispose(){this.getBackend("dispose"),setTimeout((()=>{var t,e;null==(t=this._wkr)||t.terminate(),this._wkr=void 0,null==(e=this._cbs)||e.clear()}),50)}handleMessage(t){const{cmd:e,id:s}=t.data;switch(e){default:break;case"onload":if(!this._cbs.has(s))return;this._cbs.get(s).resolve(t.data.size),this._cbs.delete(s);break;case"onerror":if(!this._cbs.has(s))return;this._cbs.get(s).reject(new Error(t.data.error)),this._cbs.delete(s);break;case"onresource":this._cbs.get(s).resolve(t.data.bitmap),this._cbs.delete(s)}}wrappedWorkerLoad(t,e,s,i,h=!1){this._cbs.set(t,{resolve:s,reject:i}),this._wkr.postMessage({cmd:"loadResource",source:e,id:t},h?[e]:[])}async wrappedLoad(t,e,s,i){try{const i=await o(e);this._rdr.cacheResource(t,i),s({width:i.width,height:i.height})}catch(h){i(h)}}setDimensions(t,e){this.getBackend("setDimensions",t,e)}createPattern(t,e){this.getBackend("createPattern",t,e)}setSmoothing(t){this.getBackend("setSmoothing",t)}setPixelRatio(t){this.getBackend("setPixelRatio",t)}save(){this.onDraw("save")}restore(){this.onDraw("restore")}translate(t,e){this.onDraw("translate",t,e)}rotate(t){this.onDraw("rotate",t)}transform(t,e,s,i,h,n){this.onDraw("transform",t,e,s,i,h,n)}scale(t,e){this.onDraw("scale",t,e)}setBlendMode(t){this.onDraw("setBlendMode",t)}setAlpha(t){this.onDraw("setAlpha",t)}drawPath(t,e,s){this.onDraw("drawPath",t,e,s)}clearRect(t,e,s,i,h){this.onDraw("clearRect",t,e,s,i,h)}drawRect(t,e,s,i,h,n,o){this.onDraw("drawRect",t,e,s,i,h,n,o)}drawRoundRect(t,e,s,i,h,n,o,a){this.onDraw("drawRoundRect",t,e,s,i,h,n,o,a)}drawCircle(t,e,s,i="transparent",h,n){this.onDraw("drawCircle",t,e,s,i,h,n)}drawEllipse(t,e,s,i,h,n,o){this.onDraw("drawEllipse",t,e,s,i,h,n,o)}drawImage(t,e,s,i,h,n){this.onDraw("drawImage",t,e,s,i,h,n)}drawImageCropped(t,e,s,i,h,n,o,a,r,l){this.onDraw("drawImageCropped",t,e,s,i,h,n,o,a,r,l)}drawText(t,e,s,i){this.onDraw("drawText",t,e,s,i)}drawPattern(t,e,s,i,h){this.onDraw("drawPattern",t,e,s,i,h)}onDraw(t,...e){if(this._useW){const s=this._pl.next();return s.length=0,s.push(t,...e),void this._cmds.push(s)}this._rdr[t](...e)}getBackend(t,...e){if(this._useW)return this._wkr.postMessage({cmd:t,args:[...e]});this._rdr[t](...e)}}const k={x:0,y:0};function M(t,e,s,i,h){return(t-e)/(s-e)*(h-i)+i}const I=[],F=[],N=i(1,1,!0).cvs;class V{constructor(t){this._renderer=t,this._cacheMap=new Map}dispose(){this._cacheMap.clear(),this._cacheMap=void 0}getChildrenInArea(t,e,s,i,h,n=!1){const o=[];let a,r,l,d,c,p=t.length;for(;p--;)a=t[p],r=a.getX(),l=a.getY(),d=a.getWidth(),c=a.getHeight(),r<e+i&&r+d>e&&l<s+h&&l+c>s&&(!n||n&&a.collidable)&&o.push(a);return o}pixelCollision(t,e){const s=t.getIntersection(e);if(void 0===s)return;this.getPixelArray(t,s,I),this.getPixelArray(e,s,F);const i=s.width,h=s.height;let n=0;for(let o=0;o<h;++o)for(let t=0;t<i;++t){if(1===I[n]&&1===F[n])return{x:t,y:o};++n}}async cache(t){const e=await this._renderer.getResource(t);if(!e)return!1;const{width:s,height:i}=e;n(N,e,s,i);const{data:h}=N.getContext("2d").getImageData(0,0,s,i),o=new Uint8Array(h.length/4);for(let n=0,a=o.length;n<a;++n){const t=h[4*n+3];o[n]=t<5?0:1}return this._cacheMap.set(t,{mask:o,size:{width:s,height:i}}),N.width=N.height=1,!0}clearCache(t){return!!this.hasCache(t)&&(this._cacheMap.delete(t),!0)}hasCache(t){return this._cacheMap.has(t)}getPixelArray(t,e,s){const i=t.getResourceId();if(!this.hasCache(i))throw new Error(`Cannot get cached entry for resource "${i}". Cache it first.`);const h=t.getBounds(),n=v(e.left-h.left),o=v(e.top-h.top),a=v(e.width),r=v(e.height),{mask:l,size:d}=this._cacheMap.get(i);if(a<=0||r<=0)return void(s.length=0);s.length=v(a*r);const c=d.height,p=d.width,u=n+a,g=o+r;let m=-1,_=0;for(let b=o;b<g;++b)for(let t=n;t<u;++t)_=t>=p||b>=c?0:l[b*p+t],s[++m]=_}}class P{constructor(){this._children=[],this._disposed=!1}addChild(t){if(this.contains(t))return this;const e=this._children.length;return e>0&&(t.last=this._children[e-1],t.last.next=t),t.next=void 0,t.setParent(this),this._children.push(t),this.invalidate(),this}removeChild(t){t.setParent(void 0),t.setCanvas(void 0);const e=this._children.indexOf(t);-1!==e&&this._children.splice(e,1);const s=t.last,i=t.next;return s&&(s.next=i),i&&(i.last=s),t.last=t.next=void 0,this.invalidate(),t}getChildAt(t){return this._children[t]}removeChildAt(t){return this.removeChild(this.getChildAt(t))}numChildren(){return this._children.length}getChildren(){return this._children}contains(t){return t.getParent()===this}invalidate(){}dispose(){this._disposed=!0,this._parent&&this._parent.removeChild(this);let t=this._children.length;for(;t--;){const e=this._children[t];e.dispose(),e.next=void 0,e.last=void 0}this._children=[]}}const{min:J,max:Q}=Math,{min:U,max:j}=Math,B=.5;t.Canvas=class extends P{constructor({width:t=300,height:e=300,fps:s=60,backgroundColor:i=null,animate:h=!1,smoothing:n=!0,stretchToFit:o=!1,autoSize:a=!0,viewport:r=null,preventEventBubbling:l=!1,parentElement:d=null,debug:c=!1,optimize:p="auto",viewportHandler:u,onUpdate:g,onResize:m}={}){if(super(),this.DEBUG=!1,this.bbox={left:0,top:0,right:0,bottom:0},this._smooth=!1,this._stretch=!1,this._pxr=1,this._prevDef=!1,this._lastRender=0,this._renderId=0,this._renderPending=!1,this._disposed=!1,this._scale={x:1,y:1},this._aTchs=[],this._animate=!1,this._isFs=!1,this._hasFsH=!1,t<=0||e<=0)throw new Error("cannot construct a zCanvas without valid dimensions");this.DEBUG=c,this._el=document.createElement("canvas"),this._rdr=new K(this._el,function(t){if("worker"===t)return!0;const{userAgent:e}=navigator,s=e.includes("Safari")&&!e.includes("Chrome");return"auto"===t&&!s}(p),c),this.collision=new V(this._rdr),this._upHdlr=g,this._renHdlr=this.render.bind(this),this._vpHdlr=u,this._resHdrl=m,this.setFrameRate(s),this.setAnimatable(h),i&&this.setBackgroundColor(i),this._pxr=window.devicePixelRatio||1,this._rdr.setPixelRatio(this._pxr),this.setDimensions(t,e,!0,!0),r&&this.setViewport(r.width,r.height),this._stretch=o,this.setSmoothing(n),this.preventEventBubbling(l),this.addListeners(a),d instanceof HTMLElement&&this.insertInPage(d),requestAnimationFrame((()=>this.handleResize()))}loadResource(t,e){return this._rdr.loadResource(t,e)}getResource(t){return this._rdr.getResource(t)}disposeResource(t){return this._rdr.disposeResource(t)}async getContent(t){const e=document.createElement("canvas");return n(e,t?await this.getResource(t):this._el),e}getRenderer(){return this._rdr}insertInPage(t){if(this._el.parentNode)throw new Error("Canvas already present in DOM");t.appendChild(this._el)}getElement(){return this._el}preventEventBubbling(t){this._prevDef=t}addChild(t){return t.setCanvas(this),super.addChild(t)}invalidate(){this._animate||this._renderPending||(this._renderPending=!0,this._renderId=window.requestAnimationFrame(this._renHdlr))}getFrameRate(){return this._fps}setFrameRate(t){this._fps=t,this._aFps=t,this._rIval=1e3/t}getActualFrameRate(){return this._aFps}getRenderInterval(){return this._rIval}getSmoothing(){return this._smooth}setSmoothing(t){this._rdr.setSmoothing(t),t?this._el.style["image-rendering"]="":["-moz-crisp-edges","-webkit-crisp-edges","pixelated","crisp-edges"].forEach((t=>{this._el.style["image-rendering"]=t})),this._smooth=t,this.invalidate()}getWidth(){return this._qSize?this._qSize.width:this._width}getHeight(){return this._qSize?this._qSize.height:this._height}setDimensions(t,e,s=!0,i=!1){this._qSize={width:t,height:e},s&&(this._prefWidth=t,this._prefHeight=e),i&&this.updateCanvasSize(),this.invalidate()}getViewport(){return this._vp}setViewport(t,e){this._vp||(this._vp={width:t,height:e,left:0,top:0,right:t,bottom:e});const s=this._vp;s.width=t,s.height=e,this.panViewport(Math.min(s.left,t),Math.min(s.top,e))}panViewport(t,e,s=!1){var i;const h=this._vp;h.left=Q(0,J(t,this._width-h.width)),h.right=h.left+h.width,h.top=Q(0,J(e,this._height-h.height)),h.bottom=h.top+h.height,this.invalidate(),s&&(null==(i=this._vpHdlr)||i.call(this,{type:"panned",value:h}))}setBackgroundColor(t){this._bgColor=t}setAnimatable(t){this._lastRaf=window.performance.now(),t&&!this._renderPending&&this.invalidate(),this._animate=t}isAnimatable(){return this._animate}scale(t,e=t){this._scale={x:t,y:e};const s=1===t&&1===e?"":`scale(${t}, ${e})`,{style:i}=this._el;i["-webkit-transform-origin"]=i["transform-origin"]="0 0",i["-webkit-transform"]=i.transform=s,this.invalidate()}stretchToFit(t){this._stretch=t,this.handleResize()}setFullScreen(t,e=!1){if(e||(e=this._stretch),!this._hasFsH){this._hasFsH=!0;const t=document,s=()=>{this._isFs=t.webkitIsFullScreen||t.mozFullScreen||!0===t.msFullscreenElement,e&&(this._stretch=this._isFs)};["webkitfullscreenchange","mozfullscreenchange","fullscreenchange","MSFullscreenChange"].forEach((e=>{this._hdlr.add(t,e,s)}))}t!==this._isFs&&function(t){let e;e=t.fullscreenElement||t.webkitFullscreenElement?t.exitFullscreen||t.webkitExitFullscreen||t.mozCancelFullScreen||t.msExitFullscreen:t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullscreen,e&&e.call(t)}(this._el)}getCoordinate(){return void 0===this._coords&&(this._coords=this._el.getBoundingClientRect()),this._coords}dispose(){this._disposed||(this._animate=!1,window.cancelAnimationFrame(this._renderId),this.removeListeners(),super.dispose(),this._el.parentNode&&this._el.parentNode.removeChild(this._el),requestAnimationFrame((()=>{this._rdr.dispose(),this._rdr=void 0,this.collision.dispose(),this.collision=void 0})),this._disposed=!0)}handleInteraction(t){const e=this._children.length,s=this._vp;let i;if(e>0)switch(i=this._children[e-1],t.type){default:let h=0,n=0;const o=t.changedTouches;let a=0,r=o.length;const l=1/this._scale.x,d=1/this._scale.y;if(r>0){let{x:c,y:p}=this.getCoordinate();for(s&&(c-=s.left,p-=s.top),a=0;a<r;++a){const s=o[a],{identifier:r}=s;if(h=s.pageX*l-c,n=s.pageY*d-p,"touchstart"===t.type){for(;i;){if(!this._aTchs.includes(i)&&i.handleInteraction(h,n,t)){this._aTchs[r]=i;break}i=i.last}i=this._children[e-1]}else i=this._aTchs[r],(null==i?void 0:i.handleInteraction(h,n,t))&&"touchmove"!==t.type&&(this._aTchs[r]=null)}}break;case"mousedown":case"mousemove":case"mouseup":let{offsetX:c,offsetY:p}=t;if(this._isFs){const e=function(t,e,s,i,h){const n=window.innerHeight/h,o=.5*(window.innerWidth-i*n);return k.x=M(t.clientX-s.left-o,0,i*n,0,e.width),k.y=M(t.clientY-s.top,0,h*n,0,e.height),k}(t,this._el,this.getCoordinate(),this._width,this._height);c=e.x/this._pxr,p=e.y/this._pxr}for(s&&(c+=s.left,p+=s.top);i&&!i.handleInteraction(c,p,t);)i=i.last;break;case"wheel":const{deltaX:u,deltaY:g}=t,m=20,_=0===u?0:u>0?m:-m,b=0===g?0:g>0?m:-m;this.panViewport(s.left+_,s.top+b,!0)}this._prevDef&&(t.stopPropagation(),t.preventDefault()),this._animate||this.invalidate()}render(t=0){this._renderPending=!1;const e=t-this._lastRender;if(this._animate&&e/this._rIval<.999)return this._renderId=window.requestAnimationFrame(this._renHdlr),void(this._lastRaf=t);let s,i;this._aFps=1e3/(t-this._lastRaf),s=this._fps>60?this._fps/this._aFps:60===this._fps&&this._aFps>63?1:1/(this._fps/this._aFps),this._lastRaf=t,this._lastRender=t-e%this._rIval,this._qSize&&this.updateCanvasSize();const h=this._width,n=this._height;this._bgColor?this._rdr.drawRect(0,0,h,n,this._bgColor):this._rdr.clearRect(0,0,h,n);const o="function"==typeof this._upHdlr;for(o&&this._upHdlr(t,s),i=this._children[0];i;)o||i.update(t,s),i.draw(this._rdr,this._vp),i=i.next;this._rdr.onCommandsReady(),!this._disposed&&this._animate&&(this._renderPending=!0,this._renderId=window.requestAnimationFrame(this._renHdlr))}addListeners(t=!1){this._hdlr||(this._hdlr=new e);const s=this._hdlr,i=this.handleInteraction.bind(this),h=this._el;"ontouchstart"in window&&["start","move","end","cancel"].forEach((t=>{s.add(h,`touch${t}`,i)})),["down","move"].forEach((t=>{s.add(h,`mouse${t}`,i)})),s.add(window,"mouseup",i),this._vp&&s.add(h,"wheel",i),t&&s.add(window,"resize",this.handleResize.bind(this))}removeListeners(){var t;null==(t=this._hdlr)||t.dispose(),this._hdlr=void 0}handleResize(){const{innerWidth:t,innerHeight:e}=window;let s=this._prefWidth,i=this._prefHeight,h=1;if(!this._vp&&this._stretch){const{width:n,height:o}=function(t,e,s,i){const h=s/i;let n=t,o=e;return t/e>h?o=t/h:n=e*h,{width:n,height:o}}(s,i,t,e);h=t/n,this.setDimensions(n,o,!1,!0)}else J(s,t),this.setDimensions(s,i,!1),this._vp||s>t&&(h=t/s);this.scale(h)}updateCanvasSize(){var t;const e=this._smooth?this._pxr:1;let s,i;if(void 0!==this._qSize&&(({width:s,height:i}=this._qSize),this._qSize=void 0,this._width=s,this._height=i,this.bbox.right=s,this.bbox.bottom=i),this._vp){const t=this._width,e=this._height;s=J(this._vp.width,t),i=J(this._vp.height,e)}if(s&&i){const h=this.getElement();this._rdr.setDimensions(s*e,i*e),h.style.width=`${s}px`,h.style.height=`${i}px`,null==(t=this._resHdrl)||t.call(this,s,i)}this._rdr.scale(e),this.setSmoothing(this._smooth),this._coords=void 0}},t.Loader=d,t.Sprite=class extends P{constructor({resourceId:t,x:e=0,y:s=0,width:i=10,height:h=10,rotation:n=0,collidable:o=!1,interactive:a=!1,mask:r=!1,sheet:l}){if(super(),this.hover=!1,this.isDragging=!1,this._mask=!1,this._interactive=!1,this._draggable=!1,this._keepInBounds=!1,this._pressed=!1,i<=0||h<=0)throw new Error("cannot construct a Sprite without valid dimensions");if(this.collidable=o,this._mask=r,this._bounds={left:e,top:s,width:i,height:h},r&&this.gdp(),0!==n&&this.setRotation(n),t&&this.setResource(t),l){if(!t)throw new Error("cannot use a spritesheet without a valid resource id");this.setSheet(l,i,h)}this.setInteractive(a)}getDraggable(){return this._draggable}setDraggable(t,e=!1){this._draggable=t,this._keepInBounds=!!this._cstrt||e,t&&!this._interactive&&this.setInteractive(!0)}getInteractive(){return this._interactive}setInteractive(t){this._interactive=t}getX(){return this._bounds.left}setX(t){const e=t-this._bounds.left;if(0===e)return;this._bounds.left=this._cstrt?t+this._cstrt.left:t,this._tfb&&(this._tfb.left+=e);let s=this._children[0];for(;s;)s.isDragging||s.setX(s._bounds.left+e),s=s.next;this.invalidate()}getY(){return this._bounds.top}setY(t){const e=t-this._bounds.top;if(0===e)return;this._bounds.top=this._cstrt?t+this._cstrt.top:t,this._tfb&&(this._tfb.top+=e);let s=this._children[0];for(;s;)s.isDragging||s.setY(s._bounds.top+e),s=s.next;this.invalidate()}getWidth(){return this._bounds.width}setWidth(t){const e=this._bounds.width;e!==t&&(this._bounds.width=t,0!==e&&(this._bounds.left-=t*B-e*B),!this._tfb||0===this.getRotation()&&1===this.getScale()||this.invalidateDrawProps({rotation:this.getRotation(),scale:this.getScale()}),this.invalidate())}getHeight(){return this._bounds.height}setHeight(t){const e=this._bounds.height;e!==t&&(this._bounds.height=t,0!==e&&(this._bounds.top-=t*B-e*B),!this._tfb||0===this.getRotation()&&1===this.getScale()||this.invalidateDrawProps({rotation:this.getRotation(),scale:this.getScale()}),this.invalidate())}setBounds(t,e,s,i){this._cstrt&&(t-=this._cstrt.left,e-=this._cstrt.top);let h=!1;"number"==typeof s&&(h=this._bounds.width!==s,this._bounds.width=s),"number"==typeof i&&(h=h||this._bounds.height!==i,this._bounds.height=i);const n=this._bounds.width,o=this._bounds.height,a=this._cstrt?this._cstrt.width:this.canvas.getWidth(),r=this._cstrt?this._cstrt.height:this.canvas.getHeight();if(this._keepInBounds){const s=U(0,-(n-a)),i=U(0,-(o-r)),h=r-o;t=U(a-n,j(t,s)),e=U(h,j(e,i))}else t>a&&(t+=n*B),e>r&&(e+=o*B);this.setX(t),this.setY(e),h&&this.invalidate()}getBounds(t=!1){return t&&this._tfb?this._tfb:this._bounds}getRotation(){var t;return(null==(t=this._dp)?void 0:t.rotation)??0}setRotation(t,e){this.invalidateDrawProps({rotation:t%360,pivot:e})}getScale(){var t;return(null==(t=this._dp)?void 0:t.scale)??1}setScale(t){this.invalidateDrawProps({scale:t})}getTransforms(){if(!this._tf){const{scale:t,rotation:e,alpha:s}=this.gdp();this._tf={scale:t,rotation:e,alpha:s}}return this._tf}isVisible(t){return!!this.canvas&&(e=this._tfb||this._bounds,s=t??this.canvas.bbox,({left:b,top:f}=e),b+e.width>=s.left&&b<=s.right&&f+e.height>=s.top&&f<=s.bottom);var e,s}insideBounds(t,e){const{left:s,top:i,width:h,height:n}=this._bounds;return t>=s&&t<=s+h&&e>=i&&e<=i+n}collidesWith(t){if(t===this)return!1;const e=this.getBounds(!0),s=t.getBounds(!0);return!(e.top+e.height<s.top||e.top>s.top+s.height||e.left+e.width<s.left||e.left>s.left+s.width)}getIntersection(t){if(this.collidesWith(t)){const e=this._bounds,s=t.getBounds(),i=j(e.left,s.left),h=j(e.top,s.top);return{left:i,top:h,width:U(e.left+e.width,s.width+s.height)-i,height:U(e.top+e.height,s.top+s.height)-h}}}collidesWithEdge(t,e){if(t===this)return!1;if(isNaN(e)||e<0||e>3)throw new Error("invalid argument for edge");switch(e){case 0:return this.getX()<=t.getX()+t.getWidth();case 1:return this.getY()<=t.getY()+t.getHeight();case 2:return this.getX()+this.getWidth()<=t.getX();case 3:return this.getY()+this.getHeight()>=t.getY()}return!1}setResource(t,e,s){this._resourceId=t,"number"==typeof e&&this.setWidth(e),"number"==typeof s&&this.setHeight(s),this.invalidate()}getResourceId(){return this._resourceId}setSheet(t,e,s){this._sheet=t,t?(this._animation={type:null,col:0,maxCol:0,fpt:0,counter:0,tileWidth:e??this.getWidth(),tileHeight:s??this.getHeight()},this.switchAnimation(0)):this._animation=void 0}switchAnimation(t){const e=this._animation,s=this._sheet[t];e.type=s,e.fpt=s.fpt,e.maxCol=s.col+(s.amount-1),e.col=s.col,e.counter=0,e.onComplete=s.onComplete}setParent(t){this._parent=t}getParent(){return this._parent}setCanvas(t){this.canvas=t;for(const e of this._children)e.setCanvas(t)}setConstraint(t,e,s,i){return this._cstrt={left:t,top:e,width:s,height:i},this._bounds.left=j(t,this._bounds.left),this._bounds.top=j(e,this._bounds.top),this._keepInBounds=!0,this.getConstraint()}getConstraint(){return this._cstrt}addChild(t){return t.setCanvas(this.canvas),super.addChild(t)}update(t,e){let s=this._children[0];for(;s;)s.update(t,e),s=s.next;this._animation&&this.updateAnimation(e)}draw(t,e){const s=this._bounds;if(this._resourceId&&this.isVisible(e)){const i=this._animation;let{left:h,top:n,width:o,height:a}=s;if(i){const s=i.tileWidth?i.tileWidth:B+o<<0,r=i.tileHeight?i.tileHeight:B+a<<0;e&&(h-=e.left,n-=e.top),t.drawImageCropped(this._resourceId,i.col*s,i.type.row*r,s,r,h,n,o,a,this.getDrawProps())}else if(e){const{src:i,dest:h}=function(t,e){({left:b,top:f,width:w,height:G}=t);const{left:s,top:i,width:h,height:n}=e;return w=b>s?g(w,h-(b-s)):g(h,w-(s-b)),G=f>i?g(G,n-(f-i)):g(n,G-(i-f)),{src:{left:b>s?0:s-b,top:f>i?0:i-f,width:w,height:G},dest:{left:b>s?b-s:0,top:f>i?f-i:0,width:w,height:G}}}(s,e);t.drawImageCropped(this._resourceId,i.left,i.top,i.width,i.height,h.left,h.top,h.width,h.height,this.getDrawProps())}else t.drawImage(this._resourceId,h,n,o,a,this.getDrawProps())}let i=this._children[0];for(;i;)i.draw(t,e),i=i.next}dispose(){this._disposed||super.dispose()}getDrawProps(){if(this._tf){const{alpha:t,rotation:e,scale:s}=this._tf;(this._dp.alpha!==t||this._dp.rotation!==e||this._dp.scale!==s)&&this.invalidateDrawProps({rotation:e,alpha:t,scale:s})}return this._dp}handlePress(t,e,s){}handleRelease(t,e,s){}handleClick(){}handleMove(t,e,s){const i=this._dro.x+(t-this._drc.x),h=this._dro.y+(e-this._drc.y);this.setBounds(i,h,this._bounds.width,this._bounds.height)}handleInteraction(t,e,s){let i;const h=this._children.length;if(h>0)for(i=this._children[h-1];i;){if(i.handleInteraction(t,e,s))return!0;i=i.last}if(!this._interactive)return!1;const{type:n}=s;if(this._pressed&&("touchend"===n||"mouseup"===n))return this._pressed=!1,this.isDragging&&(this.isDragging=!1),window.performance.now()-this._pTime<250&&this.handleClick(),this.handleRelease(t,e,s),!0;if(this.insideBounds(t,e)){if(this.hover=!0,"touchstart"===n||"mousedown"===n)return this._pTime=window.performance.now(),this._pressed=!0,this._draggable&&(this.isDragging=!0,this._dro={x:this._bounds.left,y:this._bounds.top},this._drc={x:t,y:e}),this.handlePress(t,e,s),"touchstart"===n&&(s.stopPropagation(),s.preventDefault()),!0}else this.hover=!1;return!!this.isDragging&&(this.handleMove(t,e,s),!0)}invalidate(){var t;null==(t=this.canvas)||t.invalidate()}invalidateDrawProps({alpha:t,scale:e,rotation:s,pivot:i}){const h=this.gdp();h.alpha=t??h.alpha,h.scale=e??h.scale,h.rotation=s??h.rotation,h.pivot=i??h.pivot,void 0===s&&void 0===e||(this._tfb||(this._tfb={...this._bounds}),function(t,e,s,i){if(0===e&&1===s)return Z(t,1,i);const{left:h,top:n,width:o,height:a}=Z(t,s,i);if(0!==e){const t=-o*_,s=o*_,r=o*_,l=-o*_,d=a*_,c=a*_,p=-a*_,u=-a*_,b=e*x,f=Math.cos(b),w=Math.sin(b),G=t*f+d*w,v=-t*w+d*f,Z=s*f+c*w,X=-s*w+c*f,C=r*f+p*w,R=-r*w+p*f,y=l*f+u*w,L=-l*w+u*f,W=g(G,Z,C,y),H=m(G,Z,C,y),S=g(v,X,R,L),Y=m(v,X,R,L);i.width=H-W,i.height=Y-S,i.left=h-(i.width*_-o*_),i.top=n-(i.height*_-a*_)}}(this._bounds,h.rotation,h.scale,this._tfb))}updateAnimation(t=1){const e=this._animation;e.counter+=t,e.counter>=e.fpt&&(++e.col,e.counter=e.counter%e.fpt),e.col>e.maxCol&&(e.col=e.type.col,"function"==typeof e.onComplete&&e.onComplete(this))}gdp(){return this._dp=this._dp||{alpha:1,blendMode:this._mask?"destination-in":void 0,safeMode:!1,scale:1,rotation:0},this._dp}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
