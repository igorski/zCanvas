var zcanvas=function(t){"use strict";class e{constructor(){this._eventMap=[],this._disposed=!1}add(t,e,i){return!this.has(t,e)&&(t.addEventListener(e,i,!1),this._eventMap.push({target:t,type:e,listener:i}),!0)}has(t,e){let i=this._eventMap.length;for(;i--;){const s=this._eventMap[i];if(s.target===t&&s.type==e)return!0}return!1}remove(t,e){let i=this._eventMap.length;for(;i--;){const s=this._eventMap[i];if(s.target===t&&s.type===e)return t.removeEventListener(e,s.listener,!1),this._eventMap.splice(i,1),!0}return!1}dispose(){if(this._disposed)return;let t=this._eventMap.length;for(;t--;){const e=this._eventMap[t];this.remove(e.target,e.type)}this._eventMap=null,this._disposed=!0}}let i;function s(t=0,e=0,i=!1){const s=document.createElement("canvas"),h=s.getContext("2d",i?{willReadFrequently:!0}:void 0);return 0!==t&&0!==e&&(s.width=t,s.height=e),{cvs:s,ctx:h}}function h(){return i||(i=s().cvs),i}async function n(t){t instanceof Blob&&(t=await function(t){const e=URL.createObjectURL(t),i=()=>{URL.revokeObjectURL(e)};return new Promise(((t,h)=>{const n=new Image;n.onload=()=>{const{cvs:e,ctx:h}=s(n.width,n.height);h.drawImage(n,0,0),i(),t(e)},n.onerror=t=>{i(),h(t)},n.src=e}))}(t)),a(h(),t);const e=await createImageBitmap(h());return i.width=1,i.height=1,e}function a(t,e,i,s){const h=t.getContext("2d");i=i??e.width,s=s??e.height,t.width=i,t.height=s,h.clearRect(0,0,i,s),h.drawImage(e,0,0,i,s)}const r={loadImage:(t,i)=>new Promise(((s,h)=>{const n=i||new window.Image,a=function(t){const e=("string"==typeof t?t:t.src).substring(0,5);return"data:"===e||"blob:"===e}(t),d=new e;var l;a||(l=n,function(t){const{location:e}=window;return!(!t.startsWith("./")&&!t.startsWith(`${e.protocol}//${e.host}`)&&/^http[s]?:/.test(t))}(t)||(l.crossOrigin="Anonymous"),d.add(n,"load",(()=>{d.dispose(),r.onReady(n).then((()=>s(o(n)))).catch(h)})),d.add(n,"error",(()=>{d.dispose(),h()}))),n.src=t,a&&r.onReady(n).then((()=>s(o(n)))).catch(h)})),async loadBitmap(t){const{image:e}=await r.loadImage(t);return n(e)},isReady:t=>!0===t.complete&&"number"==typeof t.naturalWidth&&t.naturalWidth>0,onReady:t=>new Promise(((e,i)=>{let s=0;!function h(){r.isReady(t)?e():60==++s?(console.error(typeof t),i(new Error("Image could not be resolved. This shouldn't occur."))):window.requestAnimationFrame(h)}()}))};function o(t){const e={image:t,size:{width:0,height:0}};return t instanceof window.HTMLImageElement&&(e.size={width:(i=t).width||i.naturalWidth,height:i.height||i.naturalHeight}),e;var i}class d{constructor(){this._map=new Map}dispose(){const t=[...this._map].map((([t])=>t));for(;t.length>0;)this.remove(t.shift());this._map=void 0}get(t){return this._map.get(t)}set(t,e){if(this.has(t)){if(this.get(t)===e)return;this.remove(t)}this._map.set(t,e)}has(t){return this._map.has(t)}remove(t){return!!this.has(t)&&(this.get(t).close(),this._map.delete(t))}}const l=.5;class c{constructor(t){this._canvas=t,this._context=t.getContext("2d"),this._cache=new d}dispose(){this._cache.dispose(),this._cache=void 0,this._canvas=void 0}cacheResource(t,e){this._cache.set(t,e)}getResource(t){return this._cache.get(t)}disposeResource(t){this._cache.remove(t)}setDimensions(t,e){this._canvas.width=t,this._canvas.height=e}setSmoothing(t){const e=this._context;["imageSmoothingEnabled","mozImageSmoothingEnabled","oImageSmoothingEnabled","webkitImageSmoothingEnabled"].forEach((i=>{void 0!==e[i]&&(e[i]=t)}))}save(){this._context.save()}restore(){this._context.restore()}scale(t,e=t){this._context.scale(t,e)}setBlendMode(t){this._context.globalCompositeOperation=t}setAlpha(t){this._context.globalAlpha=t}clearRect(t,e,i,s){this._context.clearRect(t,e,i,s)}drawRect(t,e,i,s,h,n="fill"){if("fill"===n)this._context.fillStyle=h,this._context.fillRect(t,e,i,s);else if("stroke"===n){const n=1;this._context.lineWidth=n,this._context.strokeStyle=h,this._context.strokeRect(l+(t-n),l+(e-n),i,s)}}drawCircle(t,e,i,s,h){this._context.beginPath(),this._context.arc(t+i,e+i,i,0,2*Math.PI,!1),this._context.fillStyle=s,this._context.fill(),h&&(this._context.lineWidth=5,this._context.strokeStyle=h,this._context.stroke()),this._context.closePath()}drawImage(t,e,i,s,h){this._cache.has(t)&&(void 0!==s?this._context.drawImage(this._cache.get(t),e,i,s,h):this._context.drawImage(this._cache.get(t),e,i))}drawImageCropped(t,e,i,s,h,n,a,r,o,d){if(!this._cache.has(t))return;if(null==d?void 0:d.safeMode){if(r<=0||o<=0)return;const n=this._cache.get(t),a=(r=Math.min(this._context.canvas.width,r))/s,d=(o=Math.min(this._context.canvas.height,o))/h;e+s>n.width&&(r-=a*(e+s-n.width),s-=e+s-n.width),i+h>n.height&&(o-=d*(i+h-n.height),h-=i+h-n.height)}let c=!1;if(d){const t=void 0!==d.scale,e=void 0!==d.alpha,i=void 0!==d.blend;c=t||e||i,c&&this.save(),t&&this.scale(d.scale),i&&this.setBlendMode(d.blend),e&&this.setAlpha(d.alpha)}this._context.drawImage(this._cache.get(t),l+e<<0,l+i<<0,l+s<<0,l+h<<0,l+n<<0,l+a<<0,l+r<<0,l+o<<0),c&&this.restore()}}const u="IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NsYXNzIGV7Y29uc3RydWN0b3IoKXt0aGlzLl9tYXA9bmV3IE1hcH1kaXNwb3NlKCl7Y29uc3QgZT1bLi4udGhpcy5fbWFwXS5tYXAoKChbZV0pPT5lKSk7Zm9yKDtlLmxlbmd0aD4wOyl0aGlzLnJlbW92ZShlLnNoaWZ0KCkpO3RoaXMuX21hcD12b2lkIDB9Z2V0KGUpe3JldHVybiB0aGlzLl9tYXAuZ2V0KGUpfXNldChlLHQpe2lmKHRoaXMuaGFzKGUpKXtpZih0aGlzLmdldChlKT09PXQpcmV0dXJuO3RoaXMucmVtb3ZlKGUpfXRoaXMuX21hcC5zZXQoZSx0KX1oYXMoZSl7cmV0dXJuIHRoaXMuX21hcC5oYXMoZSl9cmVtb3ZlKGUpe3JldHVybiEhdGhpcy5oYXMoZSkmJih0aGlzLmdldChlKS5jbG9zZSgpLHRoaXMuX21hcC5kZWxldGUoZSkpfX1jb25zdCB0PS41O2NsYXNzIHN7Y29uc3RydWN0b3IodCl7dGhpcy5fY2FudmFzPXQsdGhpcy5fY29udGV4dD10LmdldENvbnRleHQoIjJkIiksdGhpcy5fY2FjaGU9bmV3IGV9ZGlzcG9zZSgpe3RoaXMuX2NhY2hlLmRpc3Bvc2UoKSx0aGlzLl9jYWNoZT12b2lkIDAsdGhpcy5fY2FudmFzPXZvaWQgMH1jYWNoZVJlc291cmNlKGUsdCl7dGhpcy5fY2FjaGUuc2V0KGUsdCl9Z2V0UmVzb3VyY2UoZSl7cmV0dXJuIHRoaXMuX2NhY2hlLmdldChlKX1kaXNwb3NlUmVzb3VyY2UoZSl7dGhpcy5fY2FjaGUucmVtb3ZlKGUpfXNldERpbWVuc2lvbnMoZSx0KXt0aGlzLl9jYW52YXMud2lkdGg9ZSx0aGlzLl9jYW52YXMuaGVpZ2h0PXR9c2V0U21vb3RoaW5nKGUpe2NvbnN0IHQ9dGhpcy5fY29udGV4dDtbImltYWdlU21vb3RoaW5nRW5hYmxlZCIsIm1vekltYWdlU21vb3RoaW5nRW5hYmxlZCIsIm9JbWFnZVNtb290aGluZ0VuYWJsZWQiLCJ3ZWJraXRJbWFnZVNtb290aGluZ0VuYWJsZWQiXS5mb3JFYWNoKChzPT57dm9pZCAwIT09dFtzXSYmKHRbc109ZSl9KSl9c2F2ZSgpe3RoaXMuX2NvbnRleHQuc2F2ZSgpfXJlc3RvcmUoKXt0aGlzLl9jb250ZXh0LnJlc3RvcmUoKX1zY2FsZShlLHQ9ZSl7dGhpcy5fY29udGV4dC5zY2FsZShlLHQpfXNldEJsZW5kTW9kZShlKXt0aGlzLl9jb250ZXh0Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbj1lfXNldEFscGhhKGUpe3RoaXMuX2NvbnRleHQuZ2xvYmFsQWxwaGE9ZX1jbGVhclJlY3QoZSx0LHMsYSl7dGhpcy5fY29udGV4dC5jbGVhclJlY3QoZSx0LHMsYSl9ZHJhd1JlY3QoZSxzLGEsaSxvLGM9ImZpbGwiKXtpZigiZmlsbCI9PT1jKXRoaXMuX2NvbnRleHQuZmlsbFN0eWxlPW8sdGhpcy5fY29udGV4dC5maWxsUmVjdChlLHMsYSxpKTtlbHNlIGlmKCJzdHJva2UiPT09Yyl7Y29uc3QgYz0xO3RoaXMuX2NvbnRleHQubGluZVdpZHRoPWMsdGhpcy5fY29udGV4dC5zdHJva2VTdHlsZT1vLHRoaXMuX2NvbnRleHQuc3Ryb2tlUmVjdCh0KyhlLWMpLHQrKHMtYyksYSxpKX19ZHJhd0NpcmNsZShlLHQscyxhLGkpe3RoaXMuX2NvbnRleHQuYmVnaW5QYXRoKCksdGhpcy5fY29udGV4dC5hcmMoZStzLHQrcyxzLDAsMipNYXRoLlBJLCExKSx0aGlzLl9jb250ZXh0LmZpbGxTdHlsZT1hLHRoaXMuX2NvbnRleHQuZmlsbCgpLGkmJih0aGlzLl9jb250ZXh0LmxpbmVXaWR0aD01LHRoaXMuX2NvbnRleHQuc3Ryb2tlU3R5bGU9aSx0aGlzLl9jb250ZXh0LnN0cm9rZSgpKSx0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpfWRyYXdJbWFnZShlLHQscyxhLGkpe3RoaXMuX2NhY2hlLmhhcyhlKSYmKHZvaWQgMCE9PWE/dGhpcy5fY29udGV4dC5kcmF3SW1hZ2UodGhpcy5fY2FjaGUuZ2V0KGUpLHQscyxhLGkpOnRoaXMuX2NvbnRleHQuZHJhd0ltYWdlKHRoaXMuX2NhY2hlLmdldChlKSx0LHMpKX1kcmF3SW1hZ2VDcm9wcGVkKGUscyxhLGksbyxjLGgsbixyLGwpe2lmKCF0aGlzLl9jYWNoZS5oYXMoZSkpcmV0dXJuO2lmKG51bGw9PWw/dm9pZCAwOmwuc2FmZU1vZGUpe2lmKG48PTB8fHI8PTApcmV0dXJuO2NvbnN0IHQ9dGhpcy5fY2FjaGUuZ2V0KGUpLGM9KG49TWF0aC5taW4odGhpcy5fY29udGV4dC5jYW52YXMud2lkdGgsbikpL2ksaD0ocj1NYXRoLm1pbih0aGlzLl9jb250ZXh0LmNhbnZhcy5oZWlnaHQscikpL287cytpPnQud2lkdGgmJihuLT1jKihzK2ktdC53aWR0aCksaS09cytpLXQud2lkdGgpLGErbz50LmhlaWdodCYmKHItPWgqKGErby10LmhlaWdodCksby09YStvLXQuaGVpZ2h0KX1sZXQgZD0hMTtpZihsKXtjb25zdCBlPXZvaWQgMCE9PWwuc2NhbGUsdD12b2lkIDAhPT1sLmFscGhhLHM9dm9pZCAwIT09bC5ibGVuZDtkPWV8fHR8fHMsZCYmdGhpcy5zYXZlKCksZSYmdGhpcy5zY2FsZShsLnNjYWxlKSxzJiZ0aGlzLnNldEJsZW5kTW9kZShsLmJsZW5kKSx0JiZ0aGlzLnNldEFscGhhKGwuYWxwaGEpfXRoaXMuX2NvbnRleHQuZHJhd0ltYWdlKHRoaXMuX2NhY2hlLmdldChlKSx0K3M8PDAsdCthPDwwLHQraTw8MCx0K288PDAsdCtjPDwwLHQraDw8MCx0K248PDAsdCtyPDwwKSxkJiZ0aGlzLnJlc3RvcmUoKX19bGV0IGEsaTtvbm1lc3NhZ2U9ZT0+e3N3aXRjaChlLmRhdGEuY21kKXtkZWZhdWx0OmJyZWFrO2Nhc2UiaW5pdCI6aT1lLmRhdGEuY2FudmFzLGE9bmV3IHMoaSksY29uc29sZS5pbmZvKCItLS0gaW5pdGlhbGl6ZWQgV29ya2VyIixpLGEpO2JyZWFrO2Nhc2UibG9hZFJlc291cmNlIjohYXN5bmMgZnVuY3Rpb24oZSx0KXt0cnl7bGV0IHM7aWYodCBpbnN0YW5jZW9mIEZpbGUpe2NvbnN0IGU9YXdhaXQgYXN5bmMgZnVuY3Rpb24oZSl7Y29uc3QgdD1uZXcgRmlsZVJlYWRlcjtyZXR1cm4gbmV3IFByb21pc2UoKChzLGEpPT57dC5vbmxvYWQ9dD0+e3ZhciBpO2lmKCEobnVsbD09KGk9bnVsbD09dD92b2lkIDA6dC50YXJnZXQpP3ZvaWQgMDppLnJlc3VsdCkpcmV0dXJuIGEoKTtzKG5ldyBCbG9iKFt0LnRhcmdldC5yZXN1bHRdLHt0eXBlOmUudHlwZX0pKX0sdC5vbmVycm9yPWU9PmEoZSksdC5yZWFkQXNBcnJheUJ1ZmZlcihlKX0pKX0odCk7cz1hd2FpdCBjcmVhdGVJbWFnZUJpdG1hcChlKX1lbHNlIGlmKHQgaW5zdGFuY2VvZiBCbG9iKXM9YXdhaXQgY3JlYXRlSW1hZ2VCaXRtYXAodCk7ZWxzZSBpZigic3RyaW5nIj09dHlwZW9mIHQpe2NvbnN0IGU9YXdhaXQgZmV0Y2godCksYT1hd2FpdCBlLmJsb2IoKTtzPWF3YWl0IGNyZWF0ZUltYWdlQml0bWFwKGEpfWVsc2UgdCBpbnN0YW5jZW9mIEltYWdlQml0bWFwJiYocz10KTtudWxsPT1hfHxhLmNhY2hlUmVzb3VyY2UoZSxzKSxwb3N0TWVzc2FnZSh7Y21kOiJvbmxvYWQiLGlkOmUsc2l6ZTp7d2lkdGg6cy53aWR0aCxoZWlnaHQ6cy5oZWlnaHR9fSl9Y2F0Y2gocyl7cG9zdE1lc3NhZ2Uoe2NtZDoib25lcnJvciIsaWQ6ZSxlcnJvcjoobnVsbD09cz92b2lkIDA6cy5tZXNzYWdlKT8/c30pfX0oZS5kYXRhLmlkLGUuZGF0YS5zb3VyY2UpO2JyZWFrO2Nhc2UiZ2V0UmVzb3VyY2UiOmNvbnN0IHQ9bnVsbD09YT92b2lkIDA6YS5nZXRSZXNvdXJjZShlLmRhdGEuaWQpO3Bvc3RNZXNzYWdlKHtjbWQ6Im9ucmVzb3VyY2UiLGlkOmUuZGF0YS5pZCxiaXRtYXA6dH0pO2JyZWFrO2Nhc2UiZGlzcG9zZVJlc291cmNlIjpudWxsPT1hfHxhLmRpc3Bvc2VSZXNvdXJjZSguLi5lLmRhdGEuYXJncyk7YnJlYWs7Y2FzZSJkaXNwb3NlIjpudWxsPT1hfHxhLmRpc3Bvc2UoKSxpPXZvaWQgMCxhPXZvaWQgMDticmVhaztjYXNlInNldFNtb290aGluZyI6Y2FzZSJzZXREaW1lbnNpb25zIjpjYXNlInNhdmUiOmNhc2UicmVzdG9yZSI6Y2FzZSJzY2FsZSI6Y2FzZSJzZXRCbGVuZE1vZGUiOmNhc2Uic2V0QWxwaGEiOmNhc2UiY2xlYXJSZWN0IjpjYXNlImRyYXdSZWN0IjpjYXNlImRyYXdJbWFnZSI6Y2FzZSJkcmF3SW1hZ2VDcm9wcGVkIjphJiZhW2UuZGF0YS5jbWRdKC4uLmUuZGF0YS5hcmdzKX19fSgpOwo=",p="undefined"!=typeof window&&window.Blob&&new Blob([atob(u)],{type:"text/javascript;charset=utf-8"});function _(){let t;try{if(t=p&&(window.URL||window.webkitURL).createObjectURL(p),!t)throw"";return new Worker(t)}catch(e){return new Worker("data:application/javascript;base64,"+u)}finally{t&&(window.URL||window.webkitURL).revokeObjectURL(t)}}class m{constructor(t,e=!1){if(this._useWorker=!1,this._element=t,e&&"function"==typeof this._element.transferControlToOffscreen){this._useWorker=!0,this._callbacks=new Map;const e=t.transferControlToOffscreen();this._worker=new _,this._worker.postMessage({cmd:"init",canvas:e},[e]),this._worker.onmessage=this.handleMessage.bind(this)}else this._renderer=new c(this._element)}loadResource(t,e){return new Promise((async(i,s)=>{if(e instanceof ImageBitmap)this._useWorker?this.wrappedWorkerLoad(t,e,i,s,!0):(this._renderer.cacheResource(t,e),i({width:e.width,height:e.height}));else if("string"!=typeof e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){const s=await n(e);return this.loadResource(t,s).then((t=>i(t)))}if(e instanceof File)if(this._useWorker)this.wrappedWorkerLoad(t,e,i,s);else{const h=await async function(t){const e=new FileReader;return new Promise(((i,s)=>{e.onload=e=>{var h;if(!(null==(h=null==e?void 0:e.target)?void 0:h.result))return s();i(new Blob([e.target.result],{type:t.type}))},e.onerror=t=>s(t),e.readAsArrayBuffer(t)}))}(e);this.wrappedLoad(t,h,i,s)}else e instanceof Blob?this._useWorker?this.wrappedWorkerLoad(t,e,i,s):this.wrappedLoad(t,e,i,s):s("Unsupported resource type")}else if(e=e.startsWith("./")?new URL(e,document.baseURI).href:e,this._useWorker)this.wrappedWorkerLoad(t,e,i,s);else{const h=await r.loadImage(e);this.wrappedLoad(t,h.image,i,s)}}))}getResource(t){return new Promise(((e,i)=>{this._useWorker?(this._callbacks.set(t,{resolve:e,reject:i}),this._worker.postMessage({cmd:"getResource",id:t})):e(this._renderer.getResource(t))}))}disposeResource(t){this.getBackend("disposeResource",t)}dispose(){this.getBackend("dispose"),setTimeout((()=>{var t,e;null==(t=this._worker)||t.terminate(),this._worker=void 0,null==(e=this._callbacks)||e.clear()}),50)}getBackend(t,...e){this._useWorker?this._worker.postMessage({cmd:t,args:[...e]}):this._renderer[t](...e)}handleMessage(t){const{cmd:e,id:i}=t.data;switch(e){default:break;case"onload":if(!this._callbacks.has(i))return;this._callbacks.get(i).resolve(t.data.size),this._callbacks.delete(i);break;case"onerror":if(!this._callbacks.has(i))return;this._callbacks.get(i).reject(new Error(t.data.error)),this._callbacks.delete(i);break;case"onresource":this._callbacks.get(i).resolve(t.data.bitmap),this._callbacks.delete(i)}}wrappedWorkerLoad(t,e,i,s,h=!1){this._callbacks.set(t,{resolve:i,reject:s}),this._worker.postMessage({cmd:"loadResource",source:e,id:t},h?[e]:[])}async wrappedLoad(t,e,i,s){try{const s=await n(e);this._renderer.cacheResource(t,s),i({width:s.width,height:s.height})}catch(h){s(h)}}setDimensions(t,e){this.getBackend("setDimensions",t,e)}setSmoothing(t){this.getBackend("setSmoothing",t)}save(){this.getBackend("save")}restore(){this.getBackend("restore")}scale(t,e){this.getBackend("scale",t,e)}setBlendMode(t){this.getBackend("setBlendMode",t)}clearRect(t,e,i,s){this.getBackend("clearRect",t,e,i,s)}drawRect(t,e,i,s,h,n){this.getBackend("drawRect",t,e,i,s,h,n)}drawCircle(t,e,i,s,h){this.getBackend("drawCircle",t,e,i,s,h)}drawImage(t,e,i,s,h){this.getBackend("drawImage",t,e,i,s,h)}drawImageCropped(t,e,i,s,h,n,a,r,o,d){this.getBackend("drawImageCropped",t,e,i,s,h,n,a,r,o,d)}}const g=t=>t>0?t+.5<<0:0|t,b=[],f=[],w=s(1,1,!0).cvs;class v{constructor(){this._cacheMap=new Map}dispose(){this._cacheMap.clear(),this._cacheMap=void 0}getChildrenUnderPoint(t,e,i,s,h,n=!1){const a=[];let r,o,d,l,c,u=t.length;for(;u--;)r=t[u],o=r.getX(),d=r.getY(),l=r.getWidth(),c=r.getHeight(),o<e+s&&o+l>e&&d<i+h&&d+c>i&&(!n||n&&r.collidable)&&a.push(r);return a}pixelCollision(t,e,i=!1){const s=t.getIntersection(e);if(void 0===s)return!1;this.getPixelArray(t,s,b),this.getPixelArray(e,s,f);let h=0;if(!0===i){const t=s.width,e=s.height;for(let i=0;i<e;++i)for(let e=0;e<t;++e){if(0!==b[h]&&0!==f[h])return{x:e,y:i};++h}}else{const t=b.length;for(;h<t;++h)if(0!==b[h]&&0!==f[h])return!0}return!1}cache(t,e){const{width:i,height:s}=e;a(w,e,i,s),this._cacheMap.set(t,{data:w.getContext("2d").getImageData(0,0,i,s).data,size:{width:i,height:s}}),w.width=w.height=1}clearCache(t){return!!this.hasCache(t)&&(this._cacheMap.delete(t),!0)}hasCache(t){return this._cacheMap.has(t)}getPixelArray(t,e,i){const s=t.getResourceId();if(!this.hasCache(s))throw new Error(`Cannot get cached entry for resource "${s}". Cache it first.`);const h=t.getBounds(),n=g(e.left-h.left),a=g(e.top-h.top),r=g(e.width),o=g(e.height),{data:d,size:l}=this._cacheMap.get(s);if(0===r||0===o)return void(i.length=0);i.length=g(r*o);const c=l.width,u=a+o,p=n+r;let _=-1;for(let m=a;m<u;++m)for(let t=n;t<p;++t){const e=4*(m*c+t);i[++_]=d[e+3]}}}const{min:Z,max:X,round:W}=Math,{min:C,max:G}=Math,R=.5;return t.Canvas=class{constructor({width:t=300,height:e=300,fps:i=60,scale:s=1,backgroundColor:h=null,animate:n=!1,smoothing:a=!0,stretchToFit:r=!1,viewport:o=null,preventEventBubbling:d=!1,parentElement:l=null,debug:c=!1,viewportHandler:u,onUpdate:p}={}){if(this.DEBUG=!1,this.benchmark={minElapsed:1/0,maxElapsed:-1/0,minFps:1/0,maxFps:-1/0},this._smoothing=!1,this._stretchToFit=!1,this._HDPIscaleRatio=1,this._preventDefaults=!1,this._lastRender=0,this._renderId=0,this._renderPending=!1,this._disposed=!1,this._scale={x:1,y:1},this._activeTouches=[],this._children=[],this._animate=!1,t<=0||e<=0)throw new Error("cannot construct a zCanvas without valid dimensions");this.DEBUG=c,this._element=document.createElement("canvas"),this._renderer=new m(this._element,!0),this.collision=new v,this._updateHandler=p,this._renderHandler=this.render.bind(this),this._viewportHandler=u,this.setFrameRate(i),this.setAnimatable(n),h&&this.setBackgroundColor(h),this._HDPIscaleRatio=window.devicePixelRatio||1,this.setDimensions(t,e,!0,!0),o&&this.setViewport(o.width,o.height),1!==s&&this.scale(s,s),r&&this.stretchToFit(!0),l instanceof HTMLElement&&this.insertInPage(l),this.setSmoothing(a),this.preventEventBubbling(d),this.addListeners(),this._animate&&this.render()}loadResource(t,e){return this._renderer.loadResource(t,e)}getResource(t){return this._renderer.getResource(t)}disposeResource(t){return this._renderer.disposeResource(t)}insertInPage(t){if(this._element.parentNode)throw new Error("Canvas already present in DOM");t.appendChild(this._element)}getElement(){return this._element}preventEventBubbling(t){this._preventDefaults=t}addChild(t){if(this.contains(t))return this;const e=this._children.length;return e>0&&(t.last=this._children[e-1],t.last.next=t),t.next=void 0,t.setCanvas(this),t.setParent(this),this._children.push(t),this.invalidate(),this}removeChild(t){t.setParent(void 0),t.setCanvas(void 0);const e=this._children.indexOf(t);-1!==e&&this._children.splice(e,1);const i=t.last,s=t.next;return i&&(i.next=s),s&&(s.last=i),t.last=t.next=void 0,this.invalidate(),t}getChildAt(t){return this._children[t]}removeChildAt(t){return this.removeChild(this.getChildAt(t))}numChildren(){return this._children.length}getChildren(){return this._children}contains(t){return t.canvas===this}invalidate(){this._animate||this._renderPending||(this._renderPending=!0,this._renderId=window.requestAnimationFrame(this._renderHandler))}getFrameRate(){return this._fps}setFrameRate(t){this._fps=t,this._aFps=t,this._renderInterval=1e3/t}getActualFrameRate(){return this._aFps}getRenderInterval(){return this._renderInterval}getSmoothing(){return this._smoothing}setSmoothing(t){this._renderer.setSmoothing(t),t?this._element.style["image-rendering"]="":["-moz-crisp-edges","-webkit-crisp-edges","pixelated","crisp-edges"].forEach((t=>{this._element.style["image-rendering"]=t})),this._smoothing=t,this.invalidate()}getWidth(){return this._enqueuedSize?this._enqueuedSize.width:this._width}getHeight(){return this._enqueuedSize?this._enqueuedSize.height:this._height}setDimensions(t,e,i=!0,s=!1){this._enqueuedSize={width:t,height:e},i&&(this._preferredWidth=t,this._preferredHeight=e),s&&this.updateCanvasSize(),this.invalidate()}getViewport(){return this._viewport}setViewport(t,e){this._viewport={width:t,height:e,left:0,top:0,right:t,bottom:e},this.panViewport(0,0),this.updateCanvasSize()}panViewport(t,e,i=!1){var s;const h=this._viewport;h.left=X(0,Z(t,this._width-h.width)),h.right=h.left+h.width,h.top=X(0,Z(e,this._height-h.height)),h.bottom=h.top+h.height,this.invalidate(),i&&(null==(s=this._viewportHandler)||s.call(this,{type:"panned",value:h}))}setBackgroundColor(t){this._bgColor=t}setAnimatable(t){var e;this._animate,this._animate=t,this._lastRaf=(null==(e=window.performance)?void 0:e.now())||Date.now(),t&&!this._renderPending&&this._renderHandler(this._lastRaf)}isAnimatable(){return this._animate}scale(t,e=t){this._scale={x:t,y:e};const i=1===t&&1===e?"":`scale(${t}, ${e})`,{style:s}=this._element;s["-webkit-transform-origin"]=s["transform-origin"]="0 0",s["-webkit-transform"]=s.transform=i,this.invalidate()}stretchToFit(t){this._stretchToFit=t;const{innerWidth:e,innerHeight:i}=window;let s=this._preferredWidth,h=this._preferredHeight,n=1,a=1;i>e?(h=t?i/e*s:h,n=e/s,a=i/h):(s=t?e/i*h:s,n=e/s,a=i/h),this.setDimensions(W(s),W(h),!1,!0),this.scale(n,a)}getCoordinate(){return void 0===this._coords&&(this._coords=this._element.getBoundingClientRect()),this._coords}dispose(){if(this._disposed)return;this._animate=!1,window.cancelAnimationFrame(this._renderId),this.removeListeners();let t=this.numChildren();for(;t--;)this._children[t].dispose();this._children=[],this._element.parentNode&&this._element.parentNode.removeChild(this._element),requestAnimationFrame((()=>{this._renderer.dispose(),this._renderer=void 0,this.collision.dispose(),this.collision=void 0})),this._disposed=!0}handleInteraction(t){const e=this._children.length,i=this._viewport;let s;if(e>0)switch(s=this._children[e-1],t.type){default:let h=0,n=0;const a=t.changedTouches;let r=0,o=a.length;if(o>0){let{x:d,y:l}=this.getCoordinate();for(i&&(d-=i.left,l-=i.top),r=0;r<o;++r){const i=a[r],{identifier:o}=i;if(h=i.pageX-d,n=i.pageY-l,"touchstart"===t.type){for(;s;){if(!this._activeTouches.includes(s)&&s.handleInteraction(h,n,t)){this._activeTouches[o]=s;break}s=s.last}s=this._children[e-1]}else s=this._activeTouches[o],(null==s?void 0:s.handleInteraction(h,n,t))&&"touchmove"!==t.type&&(this._activeTouches[o]=null)}}break;case"mousedown":case"mousemove":case"mouseup":let{offsetX:d,offsetY:l}=t;for(i&&(d+=i.left,l+=i.top);s&&!s.handleInteraction(d,l,t);)s=s.last;break;case"wheel":const{deltaX:c,deltaY:u}=t,p=20,_=0===c?0:c>0?p:-p,m=0===u?0:u>0?p:-p;this.panViewport(i.left+_,i.top+m,!0)}this._preventDefaults&&(t.stopPropagation(),t.preventDefault()),this._animate||this.invalidate()}render(t=0){this._renderPending=!1;const e=t-this._lastRender;if(this._animate&&e/this._renderInterval<.999)return this._renderId=window.requestAnimationFrame(this._renderHandler),void(this._lastRaf=t);let i,s;this._aFps=1e3/(t-this._lastRaf),i=this._fps>60?this._fps/this._aFps:60===this._fps&&this._aFps>63?1:1/(this._fps/this._aFps),this._lastRaf=t,this._lastRender=t-e%this._renderInterval,this._enqueuedSize&&this.updateCanvasSize();const h=this._width,n=this._height;this._bgColor?this._renderer.drawRect(0,0,h,n,this._bgColor):this._renderer.clearRect(0,0,h,n);const a="function"==typeof this._updateHandler;for(a&&this._updateHandler(t,i),s=this._children[0];s;)a||s.update(t,i),s.draw(this._renderer,this._viewport),s=s.next;if(!this._disposed&&this._animate&&(this._renderPending=!0,this._renderId=window.requestAnimationFrame(this._renderHandler)),this.DEBUG&&t>2){const e=window.performance.now()-t;this.benchmark.minElapsed=Math.min(this.benchmark.minElapsed,e),this.benchmark.maxElapsed=Math.max(this.benchmark.maxElapsed,e),this._aFps!==1/0&&(this.benchmark.minFps=Math.min(this.benchmark.minFps,this._aFps),this.benchmark.maxFps=Math.max(this.benchmark.maxFps,this._aFps))}}addListeners(){this._eventHandler||(this._eventHandler=new e);const t=this._eventHandler,i=this.handleInteraction.bind(this),s=this._element;"ontouchstart"in window&&["start","move","end","cancel"].forEach((e=>{t.add(s,`touch${e}`,i)})),["down","move"].forEach((e=>{t.add(s,`mouse${e}`,i)})),t.add(window,"mouseup",i),this._viewport&&t.add(s,"wheel",i),this._stretchToFit&&t.add(window,"resize",(()=>{this.stretchToFit(this._stretchToFit)}))}removeListeners(){var t;null==(t=this._eventHandler)||t.dispose(),this._eventHandler=void 0}updateCanvasSize(){const t=this._HDPIscaleRatio;let e,i;if(void 0!==this._enqueuedSize&&(({width:e,height:i}=this._enqueuedSize),this._enqueuedSize=void 0,this._width=e,this._height=i),this._viewport){const t=this._width,s=this._height;e=Z(this._viewport.width,t),i=Z(this._viewport.height,s)}if(e&&i){const s=this.getElement();this._renderer.setDimensions(e*t,i*t),s.style.width=`${e}px`,s.style.height=`${i}px`}this._renderer.scale(t,t),this.setSmoothing(this._smoothing),this._coords=void 0}},t.Loader=r,t.Sprite=class{constructor({width:t,height:e,resourceId:i,x:s=0,y:h=0,collidable:n=!1,interactive:a=!1,mask:r=!1,sheet:o=[],sheetTileWidth:d=0,sheetTileHeight:l=0}={width:64,height:64}){if(this.hover=!1,this.isDragging=!1,this._children=[],this._disposed=!1,this._mask=!1,this._interactive=!1,this._draggable=!1,this._keepInBounds=!1,this._pressed=!1,t<=0||e<=0)throw new Error("cannot construct a Sprite without valid dimensions");if(this.collidable=n,this._mask=r,this._bounds={left:0,top:0,width:t,height:e},this.setX(s),this.setY(h),this.setInteractive(a),i&&this.setResource(i),Array.isArray(o)&&o.length>0){if(!i)throw new Error("cannot use a spritesheet without a valid resource id");this.setSheet(o,d,l)}}getDraggable(){return this._draggable}setDraggable(t,e=!1){this._draggable=t,this._keepInBounds=!!this._constraint||e,t&&!this._interactive&&this.setInteractive(!0)}getX(){return this._bounds.left}setX(t){const e=t-this._bounds.left;this._bounds.left=this._constraint?t+this._constraint.left:t;let i=this._children[0];for(;i;)i.isDragging||i.setX(i._bounds.left+e),i=i.next}getY(){return this._bounds.top}setY(t){const e=t-this._bounds.top;this._bounds.top=this._constraint?t+this._constraint.top:t;let i=this._children[0];for(;i;)i.isDragging||i.setY(i._bounds.top+e),i=i.next}getWidth(){return this._bounds.width}setWidth(t){const e=this._bounds.width||0;e!==t&&(this._bounds.width=t,0!==e&&(this._bounds.left-=t*R-e*R),this.invalidate())}getHeight(){return this._bounds.height}setHeight(t){const e=this._bounds.height||0;e!==t&&(this._bounds.height=t,0!==e&&(this._bounds.top-=t*R-e*R),this.invalidate())}setBounds(t,e,i,s){if(this._constraint)t-=this._constraint.left,e-=this._constraint.top;else if(!this.canvas)throw new Error("cannot update position of a Sprite that has no constraint or is not added to a canvas");let h=!1;"number"==typeof i&&(h=this._bounds.width!==i,this._bounds.width=i),"number"==typeof s&&(h=h||this._bounds.height!==s,this._bounds.height=s);const n=this._bounds.width,a=this._bounds.height,r=this._constraint?this._constraint.width:this.canvas.getWidth(),o=this._constraint?this._constraint.height:this.canvas.getHeight();if(this._keepInBounds){const i=C(0,-(n-r)),s=C(0,-(a-o)),h=o-a;t=C(r-n,G(t,i)),e=C(h,G(e,s))}else t>r&&(t+=n*R),e>o&&(e+=a*R);this.setX(t),this.setY(e),h&&this.invalidate()}getBounds(){return this._bounds}getInteractive(){return this._interactive}setInteractive(t){this._interactive=t}update(t,e){let i=this._children[0];for(;i;)i.update(t,e),i=i.next;this._animation&&this.updateAnimation(e)}draw(t,e){if(!this.canvas)return;const i=this._bounds;let s=!!this._resourceId;s&&e&&(s=((t,e)=>{const{left:i,top:s}=t;return i+t.width>=e.left&&i<=e.right&&s+t.height>=e.top&&s<=e.bottom})(i,e));let h=this._mask;if(h&&t.save(),this._mask&&t.setBlendMode("destination-in"),s){const s=this._animation;let{left:h,top:n,width:a,height:r}=i;if(s){const i=s.tileWidth?s.tileWidth:R+a<<0,o=s.tileHeight?s.tileHeight:R+r<<0;e&&(h-=e.left,n-=e.top),t.drawImageCropped(this._resourceId,s.col*i,s.type.row*o,i,o,h,n,a,r)}else if(e){const{src:s,dest:h}=((t,e)=>{let{left:i,top:s,width:h,height:n}=t;const{left:a,top:r,width:o,height:d}=e;return h=i>a?Math.min(h,o-(i-a)):Math.min(o,h-(a-i)),n=s>r?Math.min(n,d-(s-r)):Math.min(d,n-(r-s)),{src:{left:i>a?0:a-i,top:s>r?0:r-s,width:h,height:n},dest:{left:i>a?i-a:0,top:s>r?s-r:0,width:h,height:n}}})(i,e);t.drawImageCropped(this._resourceId,s.left,s.top,s.width,s.height,h.left,h.top,h.width,h.height)}else t.drawImage(this._resourceId,h,n,a,r)}let n=this._children[0];for(;n;)n.draw(t,e),n=n.next;this._mask&&t.setBlendMode("source-over"),this.canvas.DEBUG&&t.drawRect(this.getX(),this.getY(),this.getWidth(),this.getHeight(),"#FF0000","stroke"),h&&t.restore()}insideBounds(t,e){const{left:i,top:s,width:h,height:n}=this._bounds;return t>=i&&t<=i+h&&e>=s&&e<=s+n}collidesWith(t){if(t===this)return!1;const e=this._bounds,i=t.getBounds();return!(e.top+e.height<i.top||e.top>i.top+i.height||e.left+e.width<i.left||e.left>i.left+i.width)}getIntersection(t){if(this.collidesWith(t)){const e=this._bounds,i=t.getBounds(),s=G(e.left,i.left),h=G(e.top,i.top);return{left:s,top:h,width:C(e.left+e.width,i.width+i.height)-s,height:C(e.top+e.height,i.top+i.height)-h}}}collidesWithEdge(t,e){if(t===this)return!1;if(isNaN(e)||e<0||e>3)throw new Error("invalid argument for edge");switch(e){case 0:return this.getX()<=t.getX()+t.getWidth();case 1:return this.getY()<=t.getY()+t.getHeight();case 2:return this.getX()+this.getWidth()<=t.getX();case 3:return this.getY()+this.getHeight()>=t.getY()}return!1}setResource(t,e,i){this._resourceId=t;const s="number"==typeof e,h="number"==typeof i;if(s&&this.setWidth(e),h&&this.setHeight(i),this._keepInBounds&&this.canvas&&(s||h)){const t=-(this._bounds.width-this.canvas.getWidth()),e=-(this._bounds.height-this.canvas.getHeight());this._bounds.left>0?this._bounds.left=0:this._bounds.left<t&&(this._bounds.left=t),this._bounds.top>0?this._bounds.top=0:this._bounds.top<e&&(this._bounds.top=e)}}getResourceId(){return this._resourceId}setSheet(t,e,i){this._sheet=t,t?(this._animation={type:null,col:0,maxCol:0,fpt:0,counter:0,tileWidth:this.getWidth(),tileHeight:this.getHeight()},"number"==typeof e&&(this._animation.tileWidth=e),"number"==typeof i&&(this._animation.tileHeight=i),this.switchAnimation(0)):this._animation=void 0}switchAnimation(t){const e=this._animation,i=this._sheet[t];e.type=i,e.fpt=i.fpt,e.maxCol=i.col+(i.amount-1),e.col=i.col,e.counter=0,e.onComplete=i.onComplete}setParent(t){this._parent=t}getParent(){return this._parent}setCanvas(t){this.canvas=t;for(const e of this._children)e.setCanvas(t)}setConstraint(t,e,i,s){return this._constraint={left:t,top:e,width:i,height:s},this._bounds.left=G(t,this._bounds.left),this._bounds.top=G(e,this._bounds.top),this._keepInBounds=!0,this.getConstraint()}getConstraint(){return this._constraint}addChild(t){if(this.contains(t))return this;const e=this._children.length;return e>0&&(t.last=this._children[e-1],t.last.next=t,t.next=void 0),t.setCanvas(this.canvas),t.setParent(this),this._children.push(t),this.invalidate(),this}removeChild(t){t.setParent(void 0),t.setCanvas(void 0);const e=this._children.indexOf(t);-1!==e&&this._children.splice(e,1);const i=t.last,s=t.next;return i&&(i.next=s),s&&(s.last=i),t.last=t.next=void 0,this.invalidate(),t}getChildAt(t){return this._children[t]}removeChildAt(t){return this.removeChild(this.getChildAt(t))}numChildren(){return this._children.length}getChildren(){return this._children}contains(t){return t._parent===this}dispose(){if(this._disposed)return;this._disposed=!0,this._parent&&this._parent.removeChild(this);let t=this._children.length;for(;t--;){const e=this._children[t];e.dispose(),e.next=void 0,e.last=void 0}this._children=[]}handlePress(t,e,i){}handleRelease(t,e,i){}handleClick(){}handleMove(t,e,i){const s=this._dragStartOffset.x+(t-this._dragStartEventCoordinates.x),h=this._dragStartOffset.y+(e-this._dragStartEventCoordinates.y);this.setBounds(s,h,this._bounds.width,this._bounds.height)}handleInteraction(t,e,i){let s,h=!1;const n=this._children.length;if(n>0)for(s=this._children[n-1];s;){if(h=s.handleInteraction(t,e,i),h)return!0;s=s.last}if(!this._interactive)return!1;const{type:a}=i;if(this._pressed&&("touchend"===a||"mouseup"===a))return this._pressed=!1,this.isDragging&&(this.isDragging=!1),Date.now()-this._pressTime<250&&this.handleClick(),this.handleRelease(t,e,i),!0;if(this.insideBounds(t,e)){if(this.hover=!0,"touchstart"===a||"mousedown"===a)return this._pressTime=Date.now(),this._pressed=!0,this._draggable&&(this.isDragging=!0,this._dragStartOffset={x:this._bounds.left,y:this._bounds.top},this._dragStartEventCoordinates={x:t,y:e}),this.handlePress(t,e,i),"touchstart"===a&&(i.stopPropagation(),i.preventDefault()),!0}else this.hover=!1;return!!this.isDragging&&(this.handleMove(t,e,i),!0)}invalidate(){this.canvas&&this.canvas.invalidate()}updateAnimation(t=1){const e=this._animation;e.counter+=t,e.counter>=e.fpt&&(++e.col,e.counter=e.counter%e.fpt),e.col>e.maxCol&&(e.col=e.type.col,"function"==typeof e.onComplete&&e.onComplete(this))}},Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),t}({});
